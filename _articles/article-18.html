---
article: 18
title: "How to customise the TWebBrowser user interface"
summary: "When we use TWebBroswer we often want to change the way it appears and acts to fit in to our application's
look and feel. Here's how to override the IE context menu, change the border style, show or hide scroll bars and style
the content without changing the HTML document."
meta-title: "Use Delphi Pascal to customise the TWebBrowser user interface | How to"
meta-desc: "An article that shows how to override the Delphi Pascal TWebBrowser control's appearance, the default pop-up
menu, and loaded document styling using CSS."
pages: 1
index: true
redirect_from:
- /articles/18
---

<!-- 18-2.inc -->

<section id="contents">

    <h2>
        Contents
    </h2>

    <nav>
        <div class="well">
            <ul>
                <li>
                    <a href="#intro">Introduction</a>
                </li>
                <li>
                    <a href="#overview">Overview of a solution</a>
                </li>
                <li>
                    <a href="#tnulwbcontainer">Developing a reusable base class</a>
                    <ul>
                        <li>
                            <a href="#getting-started">Getting started</a>
                        </li>
                        <li>
                            <a href="#non-ref-count-obj">Implementing a non reference counted object</a>
                        </li>
                        <li>
                            <a href="#ioleclientsite">Implementing IOleClientSite</a>
                        </li>
                        <li>
                            <a href="#idochostuihandler">Implementing IDocHostUIHandler</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="#twbcontainer">Developing the customization class</a>
                </li>
                <li>
                    <a href="#sample-app">Exercising the code - a sample application</a>
                    <ul>
                        <li>
                            <a href="#stage1">Stage 1</a>
                        </li>
                        <li>
                            <a href="#stage2">Stage 2</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="#demo-code">Demo Code</a>
                </li>
                <li>
                    <a href="#summary">Summary</a>
                </li>
                <li>
                    <a href="#references">References</a>
                </li>
                <li>
                    <a href="#feedback">Feedback</a>
                </li>
            </ul>
        </div>
    </nav>
</section>

<section id="intro">

    <h2>
        Introduction
    </h2>

    <p>
        Among the most popular questions posed in the <var>TWebBrowser</var> newsgroups and discussed on many Delphi tips sites are:
    </p>

    <ol class="wide">
        <li>
            How do you get a <var>TWebBrowser</var> control to display the popup menu assigned to its <var>PopupMenu</var> property instead of the standard IE popup menu?
        </li>

        <li>
            How do you stop <var>TWebBrowser</var> displaying 3D borders when a document is loaded.
        </li>

        <li>
            How do you prevent <var>TWebBrowser</var> from displaying scrollbars?
        </li>
    </ol>

    <p>
        There are a three other, related, questions that we will answer in this article. They arose when I was developing the <em><a href="/software/codesnip">CodeSnip Database Viewer</a> application</em>:
    </p>

    <ol class="wide" start="4">
        <li>
            How can you make the browser control take on the look and feel of the hosting form, given that each user may have a different display configuration that is not known at design time? I needed to do this to add some HTML content to a couple of dialogue boxes and make the HTML appear to be part of the dialogue box.
        </li>
        <li>
            Users can normally select text in a browser control &ndash; something you don't want in a dialogue box. So how do you stop that?
        </li>
        <li>
            How do you ensure that the browser control uses themes when rendering widgets such as buttons when, and only when, your application is using themes?
        </li>
    </ol>

    <p>
        The answer to the first question is to create an object that implements the <var>IDocHostUIHandler</var> interface and use the object to control the popup menu.
    </p>

    <p>
        A common solution to the second and third questions is to set one of the DOM object properties to some suitable value. For example, if <var>WB</var> has type <var>TWebBrowser</var>, we must wait until a document has loaded and then do:
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre
                class="line"><span class="linenum">  1</span><span class="comment">// Switch off scrollbars</span></pre>
            <pre
                class="line"><span class="linenum">  2</span><span class="ident">WB</span><span class="sym">.</span><span class="ident">OleObject</span><span class="sym">.</span><span class="ident">document</span><span class="sym">.</span><span class="ident">body</span><span class="sym">.</span><span class="ident">style</span><span class="sym">.</span><span class="ident">overflowX</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="str">&apos;hidden&apos;</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="ident">WB</span><span class="sym">.</span><span class="ident">OleObject</span><span class="sym">.</span><span class="ident">document</span><span class="sym">.</span><span class="ident">body</span><span class="sym">.</span><span class="ident">style</span><span class="sym">.</span><span class="ident">overflowY</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="str">&apos;hidden&apos;</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">  4</span></pre>
            <pre class="line"><span class="linenum">  5</span><span class="comment">// Switch off borders</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="ident">WB</span><span class="sym">.</span><span class="ident">OleObject</span><span class="sym">.</span><span class="ident">document</span><span class="sym">.</span><span class="ident">body</span><span class="sym">.</span><span class="ident">style</span><span class="sym">.</span><span class="ident">borderstyle</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="str">&apos;none&apos;</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 1
        </div>
    </div>

    <p>
        Now, what is less well known is that we can also set the border style and the scroll bar visibility by implementing <var>IDocHostUIHandler</var>.
    </p>

    <p>
        <var>IDocHostUIHandler</var> also lets us provide a default Cascading Style Sheet (CSS) to the browser object. This provides an answer to the fourth question: we can dynamically create a style sheet that knows about a form's colour and fonts and tell the browser to use it.
    </p>

    <p>
        And as for the last two questions? You guessed it: <var>IDocHostUIHandler</var> can help here too!
    </p>

    <p>
        Unsurprisingly then, this article is all about how to create an object that implements <var>IDocHostUIHandler</var> and use it to customize the browser control. Along the way we will also have to find out how to get <var>TWebBrowser</var> to know about, and use, the object.
    </p>

</section>

<!-- 18-2.inc -->

<section id="overview">

    <h2>
        Overview of a solution
    </h2>

    <p>
        Let us assess what are trying to do. We will work towards creating an object that can customize the <var>TWebBrowser</var> control's appearance and take control of its context menu. In the interests of ease of use and reusability we will expose properties to enable users to easily configure these attributes of the browser control.
    </p>

    <p>
        So how do we go about customizing the <var>TWebBrowser</var>? According to the Microsoft&reg; Developer Network Library documentation (my emphasis):
    </p>

    <blockquote>
        <p>
            &quot;The mechanism for WebBrowser Control customization is designed to be automated when a <strong>container</strong> provides support for ActiveX controls. Whenever the WebBrowser Control is instantiated, it attempts to find <strong>IDocHostUIHandler</strong>, IDocHostUIHandler2 and IDocHostShowUI implementations from the <strong>host</strong>, if they are available. The WebBrowser Control does this by a QueryInterface call on the host's <strong>IOleClientSite</strong> interface.
        </p>
        <p>
            &quot;This architecture works automatically for an application that implements an IOleClientSite interface and that passes an IOleClientSite pointer to the WebBrowser Control through the browser's IOleObject::SetClientSite method.&quot;
        </p>
    </blockquote>

    <p>
        This tells us the following:
    </p>

    <ul class="wide">
        <li>
            We need to create a &quot;container&quot; object to host our <var>TWebBrowser</var> control.
        </li>
        <li>
            This container must implement the <var>IOleClientSite</var> interface to enable the browser control to query it when looking for our <var>IDocHostUIHandler</var> interface.
        </li>
        <li>
            We need to notify the <var>TWebBrowser</var> that we are hosting it by passing a reference to our container's <var>IOleClientSite</var> interface to the browser control via its <var>IOleObject.SetClientSite</var> method.
        </li>
        <li>
            The container object must also implement <var>IDocHostUIHandler</var>. This implementation must provide the required customization of the browser control. (We will not concern ourselves with <var>IDocHostUIHandler2</var> or <var>IDocHostShowUI</var> here).
        </li>
    </ul>

    <p>
        In addition, our container class could expose properties to be used by <em>&quot;client code&quot;</em> to control various aspects of the browser's customization.
    </p>

    <h3>
        A few design decisions
    </h3>

    <p>
        We have establised that we need to develop a container control that supports <var>IOleClientSite</var>, <var>IDocHostUIHandler</var> and, by implication, <var>IUnknown</var>. The object will also expose customization properties.
    </p>

    <p>
        Client code will instantiate the container object and manipulate its properties in the usual way. The web browser control will also access the container, but will do so via its supported interfaces. This means we will be mixing two different methods of access &ndash; by interface and by object reference. Whenever this is done on an object that supports reference counted interfaces there is a danger of the object being prematurely freed when an interface reference goes out of scope. Consequently we will manage the object's life time ourselves, i.e. it will not be reference counted.
    </p>

    <p>
        In the interests of reusability we will develop two classes:
    </p>

    <ul class="wide">
        <li>
            <var>TNulWBContainer</var> &ndash; a do-nothing container object that hosts the web browser control and implements all the required interfaces in way that has no visible effect on the web browser control. This provides a base class for classes that seek to customize <var>TWebBrowser</var> in different ways. The intention is that this base class can be reused.
        </li>

        <li>
            <var>TWBContainer</var> &ndash; a descendant of <var>TNulWBContainer</var> that adds all the customization we noted in the <a href="#intro">introduction</a>.
        </li>
    </ul>

    <div class="callout callout-info">
        <h4>
            Reusing the code
        </h4>
        <p>
            See &quot;<a href="./article-22">How to call Delphi code from scripts running in a TWebBrowser</a>&quot; for an example of how we reuse <var>TNulWBContainer</var>.
        </p>
    </div>

    <p>
        In the following two sections we will develop the code for these classes.
    </p>

</section>

<!-- 18-3.inc -->

<section id="tnulwbcontainer">

    <h2>
        Developing a reusable base class
    </h2>

    <p>
        Recall that this class, <var>TNulWBContainer</var>, will have all the features of a suitable container that hosts <var>TWebBrowser</var>. It will:
    </p>

    <ul>
        <li>
            Implement <var>IOleClientSite</var>.
        </li>
        <li>
            Implement <var>IDocHostUIHandler</var> in a neutral way.
        </li>
        <li>
            Implement <var>IUnknown</var> without reference counting.
        </li>
        <li>
            Register the container with the web browser control.
        </li>
        <li>
            Expose the hosted web browser control as a property.
        </li>
    </ul>

    <h3 id="getting-started">
        Getting Started
    </h3>

    <p>
        We will begin with the basics &ndash; getting hold of the hosted browser control and registering the container as its host. Declare a new class as per <span class="figureref">Listing 2</span>:
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre class="line"><span class="linenum">  1</span><span class="kwd">type</span></pre>
            <pre
                class="line"><span class="linenum">  2</span><span class="space">  </span><span class="ident">TNulWBContainer</span><span class="space"> </span><span class="sym">=</span><span class="space"> </span><span class="kwd">class</span><span class="sym">(</span><span class="ident">TObject</span><span class="sym">,</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">    </span><span class="ident">IUnknown</span><span class="sym">,</span><span class="space"> </span><span class="ident">IOleClientSite</span><span class="sym">,</span><span class="space"> </span><span class="ident">IDocHostUIHandler</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="space">  </span><span class="sym">)</span></pre>
            <pre
                class="line"><span class="linenum">  5</span><span class="space">  </span><span class="kwd">private</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="space">    </span><span class="ident">fHostedBrowser</span><span class="sym">:</span><span class="space"> </span><span class="ident">TWebBrowser</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  7</span><span class="space">    </span><span class="comment">// Registration method</span></pre>
            <pre
                class="line"><span class="linenum">  8</span><span class="space">    </span><span class="kwd">procedure</span><span class="space"> </span><span class="ident">SetBrowserOleClientSite</span><span class="sym">(</span><span class="kwd">const</span><span class="space"> </span><span class="ident">Site</span><span class="sym">:</span><span class="space"> </span><span class="ident">IOleClientSite</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  9</span><span class="space">  </span><span class="kwd">public</span></pre>
            <pre
                class="line"><span class="linenum"> 10</span><span class="space">    </span><span class="kwd">constructor</span><span class="space"> </span><span class="ident">Create</span><span class="sym">(</span><span class="kwd">const</span><span class="space"> </span><span class="ident">HostedBrowser</span><span class="sym">:</span><span class="space"> </span><span class="ident">TWebBrowser</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 11</span><span class="space">    </span><span class="kwd">destructor</span><span class="space"> </span><span class="ident">Destroy</span><span class="sym">;</span><span class="space"> </span><span class="kwd">override</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 12</span><span class="space">    </span><span class="kwd">property</span><span class="space"> </span><span class="ident">HostedBrowser</span><span class="sym">:</span><span class="space"> </span><span class="ident">TWebBrowser</span><span class="space"> </span><span class="kwd">read</span><span class="space"> </span><span class="ident">fHostedBrowser</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 13</span><span class="space">  </span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 2
        </div>
    </div>

    <p>
        This is quite straightforward. We define the new type and list the interfaces we are to support. The private <var>SetBrowserOleClientSite</var> method is used to register / un-register the container with the hosted browser control. We then declare a constructor that takes a reference to the browser control and make it available via a property. A destructor is also declared.
    </p>

    <p>
        <span class="figureref">Listing 3</span> shows how the constructor is
        implemented.
    </p>

    <div class="frame" id="tnulwbcontainer.create">
        <div class="code-pascal">
            <pre
                class="line"><span class="linenum">  1</span><span class="kwd">constructor</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">Create</span><span class="sym">(</span><span class="kwd">const</span><span class="space"> </span><span class="ident">HostedBrowser</span><span class="sym">:</span><span class="space"> </span><span class="ident">TWebBrowser</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">  2</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">  </span><span class="ident">Assert</span><span class="sym">(</span><span class="ident">Assigned</span><span class="sym">(</span><span class="ident">HostedBrowser</span><span class="sym">)</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="space">  </span><span class="kwd">inherited</span><span class="space"> </span><span class="ident">Create</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  5</span><span class="space">  </span><span class="ident">fHostedBrowser</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">HostedBrowser</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="space">  </span><span class="ident">SetBrowserOleClientSite</span><span class="sym">(</span><span class="ident">Self</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  7</span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 3
        </div>
    </div>

    <p>
        Here we simply check that the browser control passed to the constructor is not nil and record a reference to it in a field. Our container object then registers itself as the web browser's host by calling <var>SetBrowserOleClientSite</var> and passing a reference to the container's <var>IOleClientSite</var> interface.
    </p>

    <p>
        The destructor simply un-registers the container from the browser by passing <var>nil</var> to <var>SetBrowserOleClientSite</var>, as <span class="figureref">Listing 4</span> shows.
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre
                class="line"><span class="linenum">  1</span><span class="kwd">destructor</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">Destroy</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">  2</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">  </span><span class="ident">SetBrowserOleClientSite</span><span class="sym">(</span><span class="kwd">nil</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="space">  </span><span class="kwd">inherited</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  5</span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 4
        </div>
    </div>

    <p>
        Having discussed the purpose of <var>SetBrowserOleClientSite</var> we can now look at its implementation. See <span class="figureref">Listing 5</span>:
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre
                class="line"><span class="linenum">  1</span><span class="kwd">procedure</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">SetBrowserOleClientSite</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum">  2</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">Site</span><span class="sym">:</span><span class="space"> </span><span class="ident">IOleClientSite</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">  3</span><span class="kwd">var</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="space">  </span><span class="ident">OleObj</span><span class="sym">:</span><span class="space"> </span><span class="ident">IOleObject</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">  5</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="space">  </span><span class="ident">Assert</span><span class="sym">(</span><span class="sym">(</span><span class="ident">Site</span><span class="space"> </span><span class="sym">=</span><span class="space"> </span><span class="ident">Self</span><span class="space"> </span><span class="kwd">as</span><span class="space"> </span><span class="ident">IOleClientSite</span><span class="sym">)</span><span class="space"> </span><span class="kwd">or</span><span class="space"> </span><span class="sym">(</span><span class="ident">Site</span><span class="space"> </span><span class="sym">=</span><span class="space"> </span><span class="kwd">nil</span><span class="sym">)</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  7</span><span class="space">  </span><span class="kwd">if</span><span class="space"> </span><span class="kwd">not</span><span class="space"> </span><span class="ident">Supports</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum">  8</span><span class="space">    </span><span class="ident">fHostedBrowser</span><span class="sym">.</span><span class="ident">DefaultInterface</span><span class="sym">,</span><span class="space"> </span><span class="ident">IOleObject</span><span class="sym">,</span><span class="space"> </span><span class="ident">OleObj</span></pre>
            <pre
                class="line"><span class="linenum">  9</span><span class="space">  </span><span class="sym">)</span><span class="space"> </span><span class="kwd">then</span></pre>
            <pre
                class="line"><span class="linenum"> 10</span><span class="space">    </span><span class="kwd">raise</span><span class="space"> </span><span class="ident">Exception</span><span class="sym">.</span><span class="ident">Create</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 11</span><span class="space">      </span><span class="str">&apos;Browser&apos;&apos;s Default interface does not support IOleObject&apos;</span></pre>
            <pre
                class="line"><span class="linenum"> 12</span><span class="space">    </span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 13</span><span class="space">  </span><span class="ident">OleObj</span><span class="sym">.</span><span class="ident">SetClientSite</span><span class="sym">(</span><span class="ident">Site</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 14</span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 5
        </div>
    </div>

    <p>
        In this method we retrieve the browser's <var>IOleObject</var> interface and then call its <var>SetClientSite</var> method, passing the <var>Site</var> parameter. This parameter must be either a reference to our object's <var>IOleClientSite</var> interface, which registers the container with the <var>TWebBrowser</var> control, or it must be <span class="kwd">nil</span>, to un-register the container.
    </p>

    <div class="callout callout-info">
        <h4>
            <var>IOleObject</var>
        </h4>
        <p>
            To learn about <var>IOleObject</var> see the Windows SDK help file that ships with Delphi.
        </p>
    </div>

    <h3 id="non-ref-count-obj">
        Implementing a non reference counted object
    </h3>

    <p>
        We will now move on to implement the required interfaces, starting with <var>IUnknown</var>. As already noted, the interface will be implemented so that the object is not reference counted.
    </p>

    <p>
        <var>IUnknown</var> is defined in the <code>System</code> unit. We begin by adding its methods to a protected section of <var>TNulWBContainer</var>'s declaration. <span class="figureref">Listing 6</span> shows the changes needed.
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre class="line"><span class="linenum">  1</span><span class="kwd">type</span></pre>
            <pre
                class="line"><span class="linenum">  2</span><span class="space">  </span><span class="ident">TNulWBContainer</span><span class="space"> </span><span class="sym">=</span><span class="space"> </span><span class="kwd">class</span><span class="sym">(</span><span class="ident">TObject</span><span class="sym">,</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">    </span><span class="ident">IUnknown</span><span class="sym">,</span><span class="space"> </span><span class="ident">IOleClientSite</span><span class="sym">,</span><span class="space"> </span><span class="ident">IDocHostUIHandler</span><span class="sym">)</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="space">  </span><span class="kwd">private</span></pre>
            <pre
                class="line"><span class="linenum">  5</span><span class="space">    </span><span class="sym">..</span><span class="sym">.</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="space">  </span><span class="kwd">protected</span></pre>
            <pre
                class="line"><span class="linenum">  7</span><span class="space">    </span><span class="comment">{ IUnknown }</span></pre>
            <pre
                class="line"><span class="linenum">  8</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">QueryInterface</span><span class="sym">(</span><span class="kwd">const</span><span class="space"> </span><span class="ident">IID</span><span class="sym">:</span><span class="space"> </span><span class="ident">TGUID</span><span class="sym">;</span><span class="space"> </span><span class="kwd">out</span><span class="space"> </span><span class="ident">Obj</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  9</span><span class="space">      </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 10</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">_AddRef</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 11</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">_Release</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 12</span><span class="space">  </span><span class="kwd">public</span></pre>
            <pre
                class="line"><span class="linenum"> 13</span><span class="space">    </span><span class="sym">..</span><span class="sym">.</span></pre>
            <pre
                class="line"><span class="linenum"> 14</span><span class="space">  </span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 6
        </div>
    </div>

    <p>
        We implement these methods as shown in <span class="figureref">Listing 7</span>.
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre
                class="line"><span class="linenum">  1</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">QueryInterface</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum">  2</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">IID</span><span class="sym">:</span><span class="space"> </span><span class="ident">TGUID</span><span class="sym">;</span><span class="space"> </span><span class="kwd">out</span><span class="space"> </span><span class="ident">Obj</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">  3</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="space">  </span><span class="kwd">if</span><span class="space"> </span><span class="ident">GetInterface</span><span class="sym">(</span><span class="ident">IID</span><span class="sym">,</span><span class="space"> </span><span class="ident">Obj</span><span class="sym">)</span><span class="space"> </span><span class="kwd">then</span></pre>
            <pre
                class="line"><span class="linenum">  5</span><span class="space">    </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_OK</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="space">  </span><span class="kwd">else</span></pre>
            <pre
                class="line"><span class="linenum">  7</span><span class="space">    </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">E_NOINTERFACE</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  8</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">  9</span></pre>
            <pre
                class="line"><span class="linenum"> 10</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">_AddRef</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 11</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 12</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="sym">-</span><span class="num">1</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 13</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 14</span></pre>
            <pre
                class="line"><span class="linenum"> 15</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">_Release</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 16</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 17</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="sym">-</span><span class="num">1</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 18</span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 7
        </div>
    </div>

    <p>
        <span class="figureref">Listing 7</span> is quite straightforward. We copy the <var>QueryInterface</var> code from Delphi's implementation of <var>TInterfacedObject</var> except that we substitute <var>S_OK</var> for the 0 returned by <var>TInterfacedObject</var>'s code.
    </p>

    <p>
        To ensure the object is not reference counted, <var>_AddRef</var> and <var>_Release</var> each return -1. Furthermore, unlike in <var>TInterfacedObject</var>, our version of <var>_Release</var> never frees the object. This leaves us to manage the object's lifetime ourselves.
    </p>

    <h3 id="ioleclientsite">
        Implementing IOleClientSite
    </h3>

    <p>
        Next we move on to look at how our object will implement <var>IOleClientSite</var>.
    </p>

    <div class="callout callout-info">
        <h4>
            <var>IOleClientSite</var>
        </h4>
        <p>
            <var>IOleClientSite</var> is declared in the <code>ActiveX</code> unit. The Delphi Windows SDK help provides a full description of the interface.
        </p>
    </div>

    <p>
        Remember that, in our constructor, we register our object's <var>IOleClientSite</var> interface with the browser control. We know that browser control calls our <var>QueryInterface</var> method via the registered <var>IOleClientSite</var> interface to try to gain access to our <var>IDocHostUIHandler</var> implementation. Because the browser object doesn't require any other functionality of <var>IOleClientSite</var> we can get away with providing a minimal, &quot;do nothing&quot; implementation. Therefore we will just stub out the methods.
    </p>

    <p>
        Once again we begin by adding the interface's methods to the protected section of our class declaration. <span class="figureref">Listing 8</span> shows the required additions:
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre class="line"><span class="linenum">  1</span><span class="kwd">type</span></pre>
            <pre
                class="line"><span class="linenum">  2</span><span class="space">  </span><span class="ident">TNulWBContainer</span><span class="space"> </span><span class="sym">=</span><span class="space"> </span><span class="kwd">class</span><span class="sym">(</span><span class="ident">TObject</span><span class="sym">,</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">    </span><span class="ident">IUnknown</span><span class="sym">,</span><span class="space"> </span><span class="ident">IOleClientSite</span><span class="sym">,</span><span class="space"> </span><span class="ident">IDocHostUIHandler</span><span class="sym">)</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="space">  </span><span class="kwd">private</span></pre>
            <pre
                class="line"><span class="linenum">  5</span><span class="space">    </span><span class="sym">..</span><span class="sym">.</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="space">  </span><span class="kwd">protected</span></pre>
            <pre
                class="line"><span class="linenum">  7</span><span class="space">    </span><span class="comment">{ IUnknown }</span></pre>
            <pre
                class="line"><span class="linenum">  8</span><span class="space">    </span><span class="sym">..</span><span class="sym">.</span></pre>
            <pre
                class="line"><span class="linenum">  9</span><span class="space">    </span><span class="comment">{ IOleClientSite }</span></pre>
            <pre
                class="line"><span class="linenum"> 10</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">SaveObject</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 11</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">GetMoniker</span><span class="sym">(</span><span class="ident">dwAssign</span><span class="sym">:</span><span class="space"> </span><span class="ident">Longint</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 12</span><span class="space">      </span><span class="ident">dwWhichMoniker</span><span class="sym">:</span><span class="space"> </span><span class="ident">Longint</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 13</span><span class="space">      </span><span class="kwd">out</span><span class="space"> </span><span class="ident">mk</span><span class="sym">:</span><span class="space"> </span><span class="ident">IMoniker</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 14</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">GetContainer</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 15</span><span class="space">      </span><span class="kwd">out</span><span class="space"> </span><span class="ident">container</span><span class="sym">:</span><span class="space"> </span><span class="ident">IOleContainer</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 16</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">ShowObject</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 17</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">OnShowWindow</span><span class="sym">(</span><span class="ident">fShow</span><span class="sym">:</span><span class="space"> </span><span class="ident">BOOL</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 18</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">RequestNewObjectLayout</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 19</span><span class="space">    </span><span class="sym">..</span><span class="sym">.</span></pre>
            <pre
                class="line"><span class="linenum"> 20</span><span class="space">  </span><span class="kwd">public</span></pre>
            <pre
                class="line"><span class="linenum"> 21</span><span class="space">    </span><span class="sym">..</span><span class="sym">.</span></pre>
            <pre
                class="line"><span class="linenum"> 22</span><span class="space">  </span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 8
        </div>
    </div>

    <p>
        Our minimal implementation is shown in <span class="figureref">Listing 9</span>. The comments in the code should outline the purpose of each method and explain what is being done. We won't discuss this further here.
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre
                class="line"><span class="linenum">  1</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">GetContainer</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum">  2</span><span class="space">  </span><span class="kwd">out</span><span class="space"> </span><span class="ident">container</span><span class="sym">:</span><span class="space"> </span><span class="ident">IOleContainer</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">  </span><span class="comment">{Returns a pointer to the container&apos;s IOleContainer</span></pre>
            <pre class="line"><span class="linenum">  4</span><span class="comment">  interface}</span></pre>
            <pre class="line"><span class="linenum">  5</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="space">  </span><span class="comment">{ We do not support IOleContainer.</span></pre>
            <pre
                class="line"><span class="linenum">  7</span><span class="comment">    However we *must* set container to nil }</span></pre>
            <pre
                class="line"><span class="linenum">  8</span><span class="space">  </span><span class="ident">container</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="kwd">nil</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  9</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">E_NOINTERFACE</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 10</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 11</span></pre>
            <pre
                class="line"><span class="linenum"> 12</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">GetMoniker</span><span class="sym">(</span><span class="ident">dwAssign</span><span class="sym">,</span><span class="space"> </span><span class="ident">dwWhichMoniker</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 13</span><span class="space">  </span><span class="kwd">out</span><span class="space"> </span><span class="ident">mk</span><span class="sym">:</span><span class="space"> </span><span class="ident">IMoniker</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 14</span><span class="space">  </span><span class="comment">{Returns a moniker to an object&apos;s client site}</span></pre>
            <pre class="line"><span class="linenum"> 15</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 16</span><span class="space">  </span><span class="comment">{ We don&apos;t support monikers.</span></pre>
            <pre
                class="line"><span class="linenum"> 17</span><span class="comment">    However we *must* set mk to nil }</span></pre>
            <pre
                class="line"><span class="linenum"> 18</span><span class="space">  </span><span class="ident">mk</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="kwd">nil</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 19</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">E_NOTIMPL</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 20</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 21</span></pre>
            <pre
                class="line"><span class="linenum"> 22</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">OnShowWindow</span><span class="sym">(</span><span class="ident">fShow</span><span class="sym">:</span><span class="space"> </span><span class="ident">BOOL</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 23</span><span class="space">  </span><span class="comment">{Notifies a container when an embedded object&apos;s window</span></pre>
            <pre
                class="line"><span class="linenum"> 24</span><span class="comment">  is about to become visible or invisible}</span></pre>
            <pre class="line"><span class="linenum"> 25</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 26</span><span class="space">  </span><span class="comment">{ Return S_OK to pretend we&apos;ve responded to this }</span></pre>
            <pre
                class="line"><span class="linenum"> 27</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_OK</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 28</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 29</span></pre>
            <pre
                class="line"><span class="linenum"> 30</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">RequestNewObjectLayout</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 31</span><span class="space">  </span><span class="comment">{Asks container to allocate more or less space for</span></pre>
            <pre
                class="line"><span class="linenum"> 32</span><span class="comment">  displaying an embedded object}</span></pre>
            <pre class="line"><span class="linenum"> 33</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 34</span><span class="space">  </span><span class="comment">{ We don&apos;t support requests for a new layout }</span></pre>
            <pre
                class="line"><span class="linenum"> 35</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">E_NOTIMPL</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 36</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 37</span></pre>
            <pre
                class="line"><span class="linenum"> 38</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">SaveObject</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 39</span><span class="space">  </span><span class="comment">{Saves the object associated with the client site}</span></pre>
            <pre class="line"><span class="linenum"> 40</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 41</span><span class="space">  </span><span class="comment">{ Return S_OK to pretend we&apos;ve done this }</span></pre>
            <pre
                class="line"><span class="linenum"> 42</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_OK</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 43</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 44</span></pre>
            <pre
                class="line"><span class="linenum"> 45</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">ShowObject</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 46</span><span class="space">  </span><span class="comment">{Tells the container to position the object so it is</span></pre>
            <pre class="line"><span class="linenum"> 47</span><span class="comment">  visible to the user}</span></pre>
            <pre class="line"><span class="linenum"> 48</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 49</span><span class="space">  </span><span class="comment">{ Return S_OK to pretend we&apos;ve done this }</span></pre>
            <pre
                class="line"><span class="linenum"> 50</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_OK</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 51</span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 9
        </div>
    </div>

    <p>
        Our class can now act as a client site, or host, for the web browser control. It remains to implement the document host handler, <var>IDocHostUIHandler</var>.
    </p>


    <h3 id="idochostuihandler">
        Implementing IDocHostUIHandler
    </h3>

    <p>
        Unlike the interfaces we have already implemented, Delphi doesn't supply a declaration of <var>IDocHostUIHandler</var> for us, so we have to provide this ourselves. <span class="figureref">Listing 10</span> defines <var>IDocHostUIHandler</var>. The comments in the code give brief explanations of each method.
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre class="line"><span class="linenum">  1</span><span class="kwd">type</span></pre>
            <pre
                class="line"><span class="linenum">  2</span><span class="space">  </span><span class="ident">IDocHostUIHandler</span><span class="space"> </span><span class="sym">=</span><span class="space"> </span><span class="kwd">interface</span><span class="sym">(</span><span class="ident">IUnknown</span><span class="sym">)</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">    </span><span class="sym">[</span><span class="str">&apos;{bd3f23c0-d43e-11cf-893b-00aa00bdce1a}&apos;</span><span class="sym">]</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="space">    </span><span class="comment">{ Display a shortcut menu }</span></pre>
            <pre
                class="line"><span class="linenum">  5</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">ShowContextMenu</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">dwID</span><span class="sym">:</span><span class="space"> </span><span class="ident">DWORD</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  7</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">ppt</span><span class="sym">:</span><span class="space"> </span><span class="ident">PPOINT</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  8</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pcmdtReserved</span><span class="sym">:</span><span class="space"> </span><span class="ident">IUnknown</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  9</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pdispReserved</span><span class="sym">:</span><span class="space"> </span><span class="ident">IDispatch</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 10</span><span class="space">    </span><span class="comment">{ Retrieves the user interface capabilities and requirements</span></pre>
            <pre
                class="line"><span class="linenum"> 11</span><span class="comment">      of the application that is hosting the web browser }</span></pre>
            <pre
                class="line"><span class="linenum"> 12</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">GetHostInfo</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 13</span><span class="space">      </span><span class="kwd">var</span><span class="space"> </span><span class="ident">pInfo</span><span class="sym">:</span><span class="space"> </span><span class="ident">TDocHostUIInfo</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 14</span><span class="space">    </span><span class="comment">{ Enables us to replace browser menus and toolbars etc }</span></pre>
            <pre
                class="line"><span class="linenum"> 15</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">ShowUI</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 16</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">dwID</span><span class="sym">:</span><span class="space"> </span><span class="ident">DWORD</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 17</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pActiveObject</span><span class="sym">:</span><span class="space"> </span><span class="ident">IOleInPlaceActiveObject</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 18</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pCommandTarget</span><span class="sym">:</span><span class="space"> </span><span class="ident">IOleCommandTarget</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 19</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pFrame</span><span class="sym">:</span><span class="space"> </span><span class="ident">IOleInPlaceFrame</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 20</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pDoc</span><span class="sym">:</span><span class="space"> </span><span class="ident">IOleInPlaceUIWindow</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 21</span><span class="space">    </span><span class="comment">{ Called when the browser removes its menus and toolbars.</span></pre>
            <pre
                class="line"><span class="linenum"> 22</span><span class="comment">      We remove menus and toolbars we displayed in ShowUI }</span></pre>
            <pre
                class="line"><span class="linenum"> 23</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">HideUI</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 24</span><span class="space">    </span><span class="comment">{ Notifies that the command state has changed so the host</span></pre>
            <pre
                class="line"><span class="linenum"> 25</span><span class="comment">      can update toolbar buttons etc. }</span></pre>
            <pre
                class="line"><span class="linenum"> 26</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">UpdateUI</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 27</span><span class="space">    </span><span class="comment">{ Called when a modal UI is displayed }</span></pre>
            <pre
                class="line"><span class="linenum"> 28</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">EnableModeless</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 29</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">fEnable</span><span class="sym">:</span><span class="space"> </span><span class="ident">BOOL</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 30</span><span class="space">    </span><span class="comment">{ Called when the document window is activated or</span></pre>
            <pre class="line"><span class="linenum"> 31</span><span class="comment">      deactivated }</span></pre>
            <pre
                class="line"><span class="linenum"> 32</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">OnDocWindowActivate</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 33</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">fActivate</span><span class="sym">:</span><span class="space"> </span><span class="ident">BOOL</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 34</span><span class="space">    </span><span class="comment">{ Called when the top-level frame window is activated or</span></pre>
            <pre class="line"><span class="linenum"> 35</span><span class="comment">      deactivated }</span></pre>
            <pre
                class="line"><span class="linenum"> 36</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">OnFrameWindowActivate</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 37</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">fActivate</span><span class="sym">:</span><span class="space"> </span><span class="ident">BOOL</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 38</span><span class="space">    </span><span class="comment">{ Called when a frame or document&apos;s window&apos;s border is</span></pre>
            <pre
                class="line"><span class="linenum"> 39</span><span class="comment">      about to be changed }</span></pre>
            <pre
                class="line"><span class="linenum"> 40</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">ResizeBorder</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 41</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">prcBorder</span><span class="sym">:</span><span class="space"> </span><span class="ident">PRECT</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 42</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pUIWindow</span><span class="sym">:</span><span class="space"> </span><span class="ident">IOleInPlaceUIWindow</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 43</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">fFrameWindow</span><span class="sym">:</span><span class="space"> </span><span class="ident">BOOL</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 44</span><span class="space">    </span><span class="comment">{ Called when accelerator keys such as TAB are used }</span></pre>
            <pre
                class="line"><span class="linenum"> 45</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">TranslateAccelerator</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 46</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">lpMsg</span><span class="sym">:</span><span class="space"> </span><span class="ident">PMSG</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 47</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pguidCmdGroup</span><span class="sym">:</span><span class="space"> </span><span class="ident">PGUID</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 48</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">nCmdID</span><span class="sym">:</span><span class="space"> </span><span class="ident">DWORD</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 49</span><span class="space">    </span><span class="comment">{ Called by the web browser control to retrieve a registry</span></pre>
            <pre
                class="line"><span class="linenum"> 50</span><span class="comment">      subkey path that overrides the default IE registry settings }</span></pre>
            <pre
                class="line"><span class="linenum"> 51</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">GetOptionKeyPath</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 52</span><span class="space">      </span><span class="kwd">var</span><span class="space"> </span><span class="ident">pchKey</span><span class="sym">:</span><span class="space"> </span><span class="ident">POLESTR</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 53</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">dw</span><span class="sym">:</span><span class="space"> </span><span class="ident">DWORD</span><span class="space"> </span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 54</span><span class="space">    </span><span class="comment">{ Called when the browser is used as a drop target and enables</span></pre>
            <pre
                class="line"><span class="linenum"> 55</span><span class="comment">      the host to supply an alternative IDropTarget interface }</span></pre>
            <pre
                class="line"><span class="linenum"> 56</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">GetDropTarget</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 57</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pDropTarget</span><span class="sym">:</span><span class="space"> </span><span class="ident">IDropTarget</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 58</span><span class="space">      </span><span class="kwd">out</span><span class="space"> </span><span class="ident">ppDropTarget</span><span class="sym">:</span><span class="space"> </span><span class="ident">IDropTarget</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 59</span><span class="space">    </span><span class="comment">{ Called to obtain our IDispatch interface. Used to enable the</span></pre>
            <pre
                class="line"><span class="linenum"> 60</span><span class="comment">      browser to call methods in the host (e.g. from JavaScript) }</span></pre>
            <pre
                class="line"><span class="linenum"> 61</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">GetExternal</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 62</span><span class="space">      </span><span class="kwd">out</span><span class="space"> </span><span class="ident">ppDispatch</span><span class="sym">:</span><span class="space"> </span><span class="ident">IDispatch</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 63</span><span class="space">    </span><span class="comment">{ Gives the host an opportunity to modify the URL to be loaded }</span></pre>
            <pre
                class="line"><span class="linenum"> 64</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">TranslateUrl</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 65</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">dwTranslate</span><span class="sym">:</span><span class="space"> </span><span class="ident">DWORD</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 66</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pchURLIn</span><span class="sym">:</span><span class="space"> </span><span class="ident">POLESTR</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 67</span><span class="space">      </span><span class="kwd">var</span><span class="space"> </span><span class="ident">ppchURLOut</span><span class="sym">:</span><span class="space"> </span><span class="ident">POLESTR</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 68</span><span class="space">    </span><span class="comment">{ Allows us to replace the web browser data object. It enables</span></pre>
            <pre
                class="line"><span class="linenum"> 69</span><span class="comment">      us to block certain clipboard formats or support additional</span></pre>
            <pre
                class="line"><span class="linenum"> 70</span><span class="comment">      clipboard formats }</span></pre>
            <pre
                class="line"><span class="linenum"> 71</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">FilterDataObject</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 72</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pDO</span><span class="sym">:</span><span class="space"> </span><span class="ident">IDataObject</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 73</span><span class="space">      </span><span class="kwd">out</span><span class="space"> </span><span class="ident">ppDORet</span><span class="sym">:</span><span class="space"> </span><span class="ident">IDataObject</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 74</span><span class="space">  </span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 10
        </div>
    </div>

    <p>
        The various interfaces and structures referenced in this definition are defined in the <code>ActiveX</code> and <code>Windows</code> units. The exception is <var>TDocHostUIInfo</var> which is defined <a href="#tdochostuiinfo">later in the article</a>.
    </p>

    <p>
        Now we have defined the interface we can create the &quot;do nothing&quot; implementation in our class. To begin with add all the methods of <var>IDocHostUIHandler</var> to the protected section of <var>TNulWBContainer</var>'s declaration. I have not shown the new declaration here since it will simply repeat the methods shown in <span class="figureref">Listing 10</span>.
    </p>

    <p>
        <span class="figureref">Listing 11</span> shows how we stub out the methods in such a way as to leave the browser object unchanged. An exploration of the MSDN documentation for the interface, along with some experimentation showed me the way. The comments in the listing should explain.
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre
                class="line"><span class="linenum">  1</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">EnableModeless</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum">  2</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">fEnable</span><span class="sym">:</span><span class="space"> </span><span class="ident">BOOL</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">  3</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="space">  </span><span class="comment">{ Return S_OK to indicate we handled (ignored) OK }</span></pre>
            <pre
                class="line"><span class="linenum">  5</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_OK</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">  7</span></pre>
            <pre
                class="line"><span class="linenum">  8</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">FilterDataObject</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum">  9</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pDO</span><span class="sym">:</span><span class="space"> </span><span class="ident">IDataObject</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 10</span><span class="space">  </span><span class="kwd">out</span><span class="space"> </span><span class="ident">ppDORet</span><span class="sym">:</span><span class="space"> </span><span class="ident">IDataObject</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 11</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 12</span><span class="space">  </span><span class="comment">{ Return S_FALSE to show no data object supplied.</span></pre>
            <pre
                class="line"><span class="linenum"> 13</span><span class="comment">    We *must* also set ppDORet to nil }</span></pre>
            <pre
                class="line"><span class="linenum"> 14</span><span class="space">  </span><span class="ident">ppDORet</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="kwd">nil</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 15</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_FALSE</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 16</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 17</span></pre>
            <pre
                class="line"><span class="linenum"> 18</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">GetDropTarget</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 19</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pDropTarget</span><span class="sym">:</span><span class="space"> </span><span class="ident">IDropTarget</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 20</span><span class="space">  </span><span class="kwd">out</span><span class="space"> </span><span class="ident">ppDropTarget</span><span class="sym">:</span><span class="space"> </span><span class="ident">IDropTarget</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 21</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 22</span><span class="space">  </span><span class="comment">{ Return E_FAIL since no alternative drop target supplied.</span></pre>
            <pre
                class="line"><span class="linenum"> 23</span><span class="comment">    We *must* also set ppDropTarget to nil }</span></pre>
            <pre
                class="line"><span class="linenum"> 24</span><span class="space">  </span><span class="ident">ppDropTarget</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="kwd">nil</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 25</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">E_FAIL</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 26</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 27</span></pre>
            <pre
                class="line"><span class="linenum"> 28</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">GetExternal</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 29</span><span class="space">  </span><span class="kwd">out</span><span class="space"> </span><span class="ident">ppDispatch</span><span class="sym">:</span><span class="space"> </span><span class="ident">IDispatch</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 30</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 31</span><span class="space">  </span><span class="comment">{ Return E_FAIL to indicate we failed to supply external object.</span></pre>
            <pre
                class="line"><span class="linenum"> 32</span><span class="comment">    We *must* also set ppDispatch to nil }</span></pre>
            <pre
                class="line"><span class="linenum"> 33</span><span class="space">  </span><span class="ident">ppDispatch</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="kwd">nil</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 34</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">E_FAIL</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 35</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 36</span></pre>
            <pre
                class="line"><span class="linenum"> 37</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">GetHostInfo</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 38</span><span class="space">  </span><span class="kwd">var</span><span class="space"> </span><span class="ident">pInfo</span><span class="sym">:</span><span class="space"> </span><span class="ident">TDocHostUIInfo</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 39</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 40</span><span class="space">  </span><span class="comment">{ Return S_OK to indicate UI is OK without changes }</span></pre>
            <pre
                class="line"><span class="linenum"> 41</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_OK</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 42</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 43</span></pre>
            <pre
                class="line"><span class="linenum"> 44</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">GetOptionKeyPath</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 45</span><span class="space">  </span><span class="kwd">var</span><span class="space"> </span><span class="ident">pchKey</span><span class="sym">:</span><span class="space"> </span><span class="ident">POLESTR</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 46</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">dw</span><span class="sym">:</span><span class="space"> </span><span class="ident">DWORD</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 47</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 48</span><span class="space">  </span><span class="comment">{ Return E_FAIL to indicate we failed to override</span></pre>
            <pre
                class="line"><span class="linenum"> 49</span><span class="comment">    default registry settings }</span></pre>
            <pre
                class="line"><span class="linenum"> 50</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">E_FAIL</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 51</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 52</span></pre>
            <pre
                class="line"><span class="linenum"> 53</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">HideUI</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 54</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 55</span><span class="space">  </span><span class="comment">{ Return S_OK to indicate we handled (ignored) OK }</span></pre>
            <pre
                class="line"><span class="linenum"> 56</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_OK</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 57</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 58</span></pre>
            <pre
                class="line"><span class="linenum"> 59</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">OnDocWindowActivate</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 60</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">fActivate</span><span class="sym">:</span><span class="space"> </span><span class="ident">BOOL</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 61</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 62</span><span class="space">  </span><span class="comment">{ Return S_OK to indicate we handled (ignored) OK }</span></pre>
            <pre
                class="line"><span class="linenum"> 63</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_OK</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 64</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 65</span></pre>
            <pre
                class="line"><span class="linenum"> 66</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">OnFrameWindowActivate</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 67</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">fActivate</span><span class="sym">:</span><span class="space"> </span><span class="ident">BOOL</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 68</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 69</span><span class="space">  </span><span class="comment">{ Return S_OK to indicate we handled (ignored) OK }</span></pre>
            <pre
                class="line"><span class="linenum"> 70</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_OK</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 71</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 72</span></pre>
            <pre
                class="line"><span class="linenum"> 73</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">ResizeBorder</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 74</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">prcBorder</span><span class="sym">:</span><span class="space"> </span><span class="ident">PRECT</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 75</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pUIWindow</span><span class="sym">:</span><span class="space"> </span><span class="ident">IOleInPlaceUIWindow</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 76</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">fFrameWindow</span><span class="sym">:</span><span class="space"> </span><span class="ident">BOOL</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 77</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 78</span><span class="space">  </span><span class="comment">{ Return S_FALSE to indicate we did nothing in response }</span></pre>
            <pre
                class="line"><span class="linenum"> 79</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_FALSE</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 80</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 81</span></pre>
            <pre
                class="line"><span class="linenum"> 82</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">ShowContextMenu</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 83</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">dwID</span><span class="sym">:</span><span class="space"> </span><span class="ident">DWORD</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 84</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">ppt</span><span class="sym">:</span><span class="space"> </span><span class="ident">PPOINT</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 85</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pcmdtReserved</span><span class="sym">:</span><span class="space"> </span><span class="ident">IInterface</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 86</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pdispReserved</span><span class="sym">:</span><span class="space"> </span><span class="ident">IDispatch</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 87</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 88</span><span class="space">  </span><span class="comment">{ Return S_FALSE to notify we didn&apos;t display a menu and to</span></pre>
            <pre
                class="line"><span class="linenum"> 89</span><span class="comment">    let browser display its own menu }</span></pre>
            <pre
                class="line"><span class="linenum"> 90</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_FALSE</span></pre>
            <pre
                class="line"><span class="linenum"> 91</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 92</span></pre>
            <pre
                class="line"><span class="linenum"> 93</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">ShowUI</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 94</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">dwID</span><span class="sym">:</span><span class="space"> </span><span class="ident">DWORD</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 95</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pActiveObject</span><span class="sym">:</span><span class="space"> </span><span class="ident">IOleInPlaceActiveObject</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 96</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pCommandTarget</span><span class="sym">:</span><span class="space"> </span><span class="ident">IOleCommandTarget</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 97</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pFrame</span><span class="sym">:</span><span class="space"> </span><span class="ident">IOleInPlaceFrame</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 98</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pDoc</span><span class="sym">:</span><span class="space"> </span><span class="ident">IOleInPlaceUIWindow</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 99</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">100</span><span class="space">  </span><span class="comment">{ Return S_OK to say we displayed own UI }</span></pre>
            <pre
                class="line"><span class="linenum">101</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_OK</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">102</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">103</span></pre>
            <pre
                class="line"><span class="linenum">104</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">TranslateAccelerator</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum">105</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">lpMsg</span><span class="sym">:</span><span class="space"> </span><span class="ident">PMSG</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">106</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pguidCmdGroup</span><span class="sym">:</span><span class="space"> </span><span class="ident">PGUID</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">107</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">nCmdID</span><span class="sym">:</span><span class="space"> </span><span class="ident">DWORD</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">108</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">109</span><span class="space">  </span><span class="comment">{ Return S_FALSE to indicate no accelerators are translated }</span></pre>
            <pre
                class="line"><span class="linenum">110</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_FALSE</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">111</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">112</span></pre>
            <pre
                class="line"><span class="linenum">113</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">TranslateUrl</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum">114</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">dwTranslate</span><span class="sym">:</span><span class="space"> </span><span class="ident">DWORD</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">115</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pchURLIn</span><span class="sym">:</span><span class="space"> </span><span class="ident">POLESTR</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">116</span><span class="space">  </span><span class="kwd">var</span><span class="space"> </span><span class="ident">ppchURLOut</span><span class="sym">:</span><span class="space"> </span><span class="ident">POLESTR</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">117</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">118</span><span class="space">  </span><span class="comment">{ Return E_FAIL to indicate that no translations took place }</span></pre>
            <pre
                class="line"><span class="linenum">119</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">E_FAIL</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">120</span><span class="kwd">end</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">121</span></pre>
            <pre
                class="line"><span class="linenum">122</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TNulWBContainer</span><span class="sym">.</span><span class="ident">UpdateUI</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">123</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">124</span><span class="space">  </span><span class="comment">{ Return S_OK to indicate we handled (ignored) OK }</span></pre>
            <pre
                class="line"><span class="linenum">125</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_OK</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">126</span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 11
        </div>
    </div>

    <p>
        That completes the implementation of the &quot;do nothing&quot;, reusable, base class. If we were to create an instance of this object it would successfully host a <var>TWebBrowser</var> control, but would have no visible effect upon it.
    </p>

</section>

<!-- 18-4.inc -->

<section id="twbcontainer">

    <h2>
        Developing the customization class
    </h2>

    <p>
        As we decided above, <var>TWBContainer</var> will derive from <var>TNulWBContainer</var> and add all the required browser customization. Let us review what we want this customization to achieve:
    </p>

    <ol>
        <li>
            Display either the browser's built in pop-up menu or the menu assigned to the <var>TWebBrowser.PopupMenu</var> property.
        </li>
        <li>
            Display or hide 3D borders.
        </li>
        <li>
            Display or hide scroll bars.
        </li>
        <li>
            Customize document appearance at run time, via a custom cascading style sheet.
        </li>
        <li>
            Allow or inhibit users from selecting text in the browser control.
        </li>
        <li>
            The browser control will display themed controls (such as buttons) only when the host application is using themes.
        </li>
    </ol>

    <p>
        We will define properties to configure the customization. We will then need to re-implement just two methods of <var>IDocHostUIHandler</var> to achieve the desired results &ndash; <var>ShowContextMenu</var> and <var>GetHostInfo</var>. <var>ShowContextMenu</var> controls the display of the popup menu and <var>GetHostInfo</var> enables the browser control's appearance to be customized.
    </p>

    <p>
        <span class="figureref">Listing 12</span> shows the declaration of <var>TWBContainer</var>.
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre class="line"><span class="linenum">  1</span><span class="kwd">type</span></pre>
            <pre
                class="line"><span class="linenum">  2</span><span class="space">  </span><span class="ident">TWBContainer</span><span class="space"> </span><span class="sym">=</span><span class="space"> </span><span class="kwd">class</span><span class="sym">(</span><span class="ident">TNulWBContainer</span><span class="sym">,</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">    </span><span class="ident">IDocHostUIHandler</span><span class="sym">,</span><span class="space"> </span><span class="ident">IOleClientSite</span><span class="sym">)</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="space">  </span><span class="kwd">private</span></pre>
            <pre
                class="line"><span class="linenum">  5</span><span class="space">    </span><span class="ident">fUseCustomCtxMenu</span><span class="sym">:</span><span class="space"> </span><span class="ident">Boolean</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="space">    </span><span class="ident">fShowScrollBars</span><span class="sym">:</span><span class="space"> </span><span class="ident">Boolean</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  7</span><span class="space">    </span><span class="ident">fShow3DBorder</span><span class="sym">:</span><span class="space"> </span><span class="ident">Boolean</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  8</span><span class="space">    </span><span class="ident">fAllowTextSelection</span><span class="sym">:</span><span class="space"> </span><span class="ident">Boolean</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  9</span><span class="space">    </span><span class="ident">fCSS</span><span class="sym">:</span><span class="space"> </span><span class="kwd">string</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 10</span><span class="space">  </span><span class="kwd">protected</span></pre>
            <pre
                class="line"><span class="linenum"> 11</span><span class="space">    </span><span class="comment">{ Re-implemented IDocHostUIHandler methods }</span></pre>
            <pre
                class="line"><span class="linenum"> 12</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">ShowContextMenu</span><span class="sym">(</span><span class="kwd">const</span><span class="space"> </span><span class="ident">dwID</span><span class="sym">:</span><span class="space"> </span><span class="ident">DWORD</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 13</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">ppt</span><span class="sym">:</span><span class="space"> </span><span class="ident">PPOINT</span><span class="sym">;</span><span class="space"> </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pcmdtReserved</span><span class="sym">:</span><span class="space"> </span><span class="ident">IUnknown</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 14</span><span class="space">      </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pdispReserved</span><span class="sym">:</span><span class="space"> </span><span class="ident">IDispatch</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 15</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">GetHostInfo</span><span class="sym">(</span><span class="kwd">var</span><span class="space"> </span><span class="ident">pInfo</span><span class="sym">:</span><span class="space"> </span><span class="ident">TDocHostUIInfo</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span><span class="space"> </span><span class="kwd">stdcall</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 16</span><span class="space">  </span><span class="kwd">public</span></pre>
            <pre
                class="line"><span class="linenum"> 17</span><span class="space">    </span><span class="kwd">constructor</span><span class="space"> </span><span class="ident">Create</span><span class="sym">(</span><span class="kwd">const</span><span class="space"> </span><span class="ident">HostedBrowser</span><span class="sym">:</span><span class="space"> </span><span class="ident">TWebBrowser</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 18</span><span class="space">    </span><span class="kwd">property</span><span class="space"> </span><span class="ident">UseCustomCtxMenu</span><span class="sym">:</span><span class="space"> </span><span class="ident">Boolean</span></pre>
            <pre
                class="line"><span class="linenum"> 19</span><span class="space">      </span><span class="kwd">read</span><span class="space"> </span><span class="ident">fUseCustomCtxMenu</span><span class="space"> </span><span class="kwd">write</span><span class="space"> </span><span class="ident">fUseCustomCtxMenu</span><span class="space"> </span><span class="kwd">default</span><span class="space"> </span><span class="ident">False</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 20</span><span class="space">    </span><span class="kwd">property</span><span class="space"> </span><span class="ident">Show3DBorder</span><span class="sym">:</span><span class="space"> </span><span class="ident">Boolean</span></pre>
            <pre
                class="line"><span class="linenum"> 21</span><span class="space">      </span><span class="kwd">read</span><span class="space"> </span><span class="ident">fShow3DBorder</span><span class="space"> </span><span class="kwd">write</span><span class="space"> </span><span class="ident">fShow3DBorder</span><span class="space"> </span><span class="kwd">default</span><span class="space"> </span><span class="ident">True</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 22</span><span class="space">    </span><span class="kwd">property</span><span class="space"> </span><span class="ident">ShowScrollBars</span><span class="sym">:</span><span class="space"> </span><span class="ident">Boolean</span></pre>
            <pre
                class="line"><span class="linenum"> 23</span><span class="space">      </span><span class="kwd">read</span><span class="space"> </span><span class="ident">fShowScrollBars</span><span class="space"> </span><span class="kwd">write</span><span class="space"> </span><span class="ident">fShowScrollBars</span><span class="space"> </span><span class="kwd">default</span><span class="space"> </span><span class="ident">True</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 24</span><span class="space">    </span><span class="kwd">property</span><span class="space"> </span><span class="ident">AllowTextSelection</span><span class="sym">:</span><span class="space"> </span><span class="ident">Boolean</span></pre>
            <pre
                class="line"><span class="linenum"> 25</span><span class="space">      </span><span class="kwd">read</span><span class="space"> </span><span class="ident">fAllowTextSelection</span><span class="space"> </span><span class="kwd">write</span><span class="space"> </span><span class="ident">fAllowTextSelection</span><span class="space"> </span><span class="kwd">default</span><span class="space"> </span><span class="ident">True</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 26</span><span class="space">    </span><span class="kwd">property</span><span class="space"> </span><span class="ident">CSS</span><span class="sym">:</span><span class="space"> </span><span class="kwd">string</span></pre>
            <pre
                class="line"><span class="linenum"> 27</span><span class="space">      </span><span class="kwd">read</span><span class="space"> </span><span class="ident">fCSS</span><span class="space"> </span><span class="kwd">write</span><span class="space"> </span><span class="ident">fCSS</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 28</span><span class="space">  </span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 12
        </div>
    </div>

    <p>
        Notice that we expose a property for each of the aspects of the browser control that we will customize, with the exception of theme support which we handle automatically. The properties are:
    </p>

    <ul class="wide">
        <li>
            <var>UseCustomCtxMenu</var> &ndash; the browser control displays its default context menu when the property is false and uses the menu assigned to <var>TWebBrowser.PopupMenu</var> when true. If <var>UseContextMenu</var> is true but <var>PopupMenu</var> is not assigned then no popup menu is displayed.
        </li>
        <li>
            <var>Show3DBorder</var> &ndash; the web browser displays a 3D border when the property is true and no border when false.
        </li>
        <li>
            <var>ShowScrollBars</var> &ndash; <var>TWebBrowser</var> displays scroll bars only if the property is true.
        </li>
        <li>
            <var>AllowTextSelection</var> &ndash; permits text selection in the browser control when true and inhibits it when false.
        </li>
        <li>
            <var>CSS</var> &ndash; provides the default cascading style sheet. This string property must contain valid CSS or be set to the empty string. When set we use this property to customize the document appearance.
        </li>
    </ul>

    <p>
        The class constructor simply sets the default property values. These are chosen to leave the browser control in its default state. <span class="figureref">Listing 13</span> shows the constructor.
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre
                class="line"><span class="linenum">  1</span><span class="kwd">constructor</span><span class="space"> </span><span class="ident">TWBContainer</span><span class="sym">.</span><span class="ident">Create</span><span class="sym">(</span><span class="kwd">const</span><span class="space"> </span><span class="ident">HostedBrowser</span><span class="sym">:</span><span class="space"> </span><span class="ident">TWebBrowser</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">  2</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">  </span><span class="kwd">inherited</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="space">  </span><span class="ident">fUseCustomCtxMenu</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">False</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  5</span><span class="space">  </span><span class="ident">fShowScrollBars</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">True</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="space">  </span><span class="ident">fShow3DBorder</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">True</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  7</span><span class="space">  </span><span class="ident">fAllowTextSelection</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">True</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  8</span><span class="space">  </span><span class="ident">fCSS</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="str">&apos;&apos;</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  9</span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 13
        </div>
    </div>

    <p>
        Now we come on to the meat of the code. First let's look at how we re-implement <var>ShowContextMenu</var>. This is easier to write than to describe. See <span class="figureref">Listing 14</span> below.
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre
                class="line"><span class="linenum">  1</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TWBContainer</span><span class="sym">.</span><span class="ident">ShowContextMenu</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum">  2</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">dwID</span><span class="sym">:</span><span class="space"> </span><span class="ident">DWORD</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">ppt</span><span class="sym">:</span><span class="space"> </span><span class="ident">PPOINT</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pcmdtReserved</span><span class="sym">:</span><span class="space"> </span><span class="ident">IInterface</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  5</span><span class="space">  </span><span class="kwd">const</span><span class="space"> </span><span class="ident">pdispReserved</span><span class="sym">:</span><span class="space"> </span><span class="ident">IDispatch</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">  6</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">  7</span><span class="space">  </span><span class="kwd">if</span><span class="space"> </span><span class="ident">fUseCustomCtxMenu</span><span class="space"> </span><span class="kwd">then</span></pre>
            <pre
                class="line"><span class="linenum">  8</span><span class="space">  </span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">  9</span><span class="space">    </span><span class="comment">// tell IE we&apos;re handling the context menu</span></pre>
            <pre
                class="line"><span class="linenum"> 10</span><span class="space">    </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_OK</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 11</span><span class="space">    </span><span class="kwd">if</span><span class="space"> </span><span class="ident">Assigned</span><span class="sym">(</span><span class="ident">HostedBrowser</span><span class="sym">.</span><span class="ident">PopupMenu</span><span class="sym">)</span><span class="space"> </span><span class="kwd">then</span></pre>
            <pre
                class="line"><span class="linenum"> 12</span><span class="space">      </span><span class="comment">// browser has a pop up menu so activate it</span></pre>
            <pre
                class="line"><span class="linenum"> 13</span><span class="space">      </span><span class="ident">HostedBrowser</span><span class="sym">.</span><span class="ident">PopupMenu</span><span class="sym">.</span><span class="ident">Popup</span><span class="sym">(</span><span class="ident">ppt</span><span class="sym">.</span><span class="ident">X</span><span class="sym">,</span><span class="space"> </span><span class="ident">ppt</span><span class="sym">.</span><span class="ident">Y</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 14</span><span class="space">  </span><span class="kwd">end</span></pre>
            <pre
                class="line"><span class="linenum"> 15</span><span class="space">  </span><span class="kwd">else</span></pre>
            <pre
                class="line"><span class="linenum"> 16</span><span class="space">    </span><span class="comment">// tell IE to use default action: display own menu</span></pre>
            <pre
                class="line"><span class="linenum"> 17</span><span class="space">    </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_FALSE</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 18</span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 14
        </div>
    </div>

    <p>
        We first check the <var>fUseCustomCtxMenu</var> field to see what to do. If it is false we simply return <var>S_FALSE</var> to tell the web browser we have not handled the context menu. This causes the browser to display its default pop-up menu.
    </p>

    <p>
        When <var>fUseCustomCtxMenu</var> is true we return <var>S_OK</var> to show we are handling the context menu ourselves. This prevents the default pop-up menu from being displayed. If the browser control's <var>PopupMenu</var> property is set we display the menu by calling its <var>Popup</var> method. The <var>ppt</var> parameter supplies the co-ordinates where the mouse was right clicked. We use this to position the top left corner of the pop-up menu.
    </p>

    <p>
        <var>GetHostInfo</var> is more complex because it determines the display of the border, scroll bars, text selection, theme support and the default style sheet. We instruct the browser control about how to handle these items by filling in a <var>TDocHostUIInfo</var> structure, a pointer to which is passed as a parameter to the method. <span class="figureref">Listing 15</span> defines this structure and comments describe its fields. <span class="figureref">Listing 16</span> presents <var>GetHostInfo</var> itself.
    </p>

    <div id="tdochostuiinfo" class="frame">
        <div class="code-pascal">
            <pre class="line"><span class="linenum">  1</span><span class="kwd">type</span></pre>
            <pre
                class="line"><span class="linenum">  2</span><span class="space">  </span><span class="ident">TDocHostUIInfo</span><span class="space"> </span><span class="sym">=</span><span class="space"> </span><span class="kwd">record</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">    </span><span class="ident">cbSize</span><span class="sym">:</span><span class="space"> </span><span class="ident">ULONG</span><span class="sym">;</span><span class="space">          </span><span class="comment">// size of structure in bytes</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="space">    </span><span class="ident">dwFlags</span><span class="sym">:</span><span class="space"> </span><span class="ident">DWORD</span><span class="sym">;</span><span class="space">         </span><span class="comment">// flags that specify UI capabilities</span></pre>
            <pre
                class="line"><span class="linenum">  5</span><span class="space">    </span><span class="ident">dwDoubleClick</span><span class="sym">:</span><span class="space"> </span><span class="ident">DWORD</span><span class="sym">;</span><span class="space">   </span><span class="comment">// specified response to double click</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="space">                            </span><span class="comment">// ** some browser versions ignore this field</span></pre>
            <pre
                class="line"><span class="linenum">  7</span><span class="space">    </span><span class="ident">pchHostCss</span><span class="sym">:</span><span class="space"> </span><span class="ident">PWChar</span><span class="sym">;</span><span class="space">     </span><span class="comment">// pointer to CSS rules</span></pre>
            <pre
                class="line"><span class="linenum">  8</span><span class="space">    </span><span class="ident">pchHostNS</span><span class="sym">:</span><span class="space"> </span><span class="ident">PWChar</span><span class="sym">;</span><span class="space">      </span><span class="comment">// pointer to namespace list for custom tags</span></pre>
            <pre
                class="line"><span class="linenum">  9</span><span class="space">  </span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 15
        </div>
    </div>

    <div class="frame"">
        <div class=" code-pascal">
        <pre
            class="line"><span class="linenum">  1</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TWBContainer</span><span class="sym">.</span><span class="ident">GetHostInfo</span><span class="sym">(</span></pre>
        <pre
            class="line"><span class="linenum">  2</span><span class="space">  </span><span class="kwd">var</span><span class="space"> </span><span class="ident">pInfo</span><span class="sym">:</span><span class="space"> </span><span class="ident">TDocHostUIInfo</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">HResult</span><span class="sym">;</span></pre>
        <pre class="line"><span class="linenum">  3</span><span class="kwd">const</span></pre>
        <pre
            class="line"><span class="linenum">  4</span><span class="space">  </span><span class="ident">DOCHOSTUIFLAG_SCROLL_NO</span><span class="space"> </span><span class="sym">=</span><span class="space"> </span><span class="hex">$00000008</span><span class="sym">;</span></pre>
        <pre
            class="line"><span class="linenum">  5</span><span class="space">  </span><span class="ident">DOCHOSTUIFLAG_NO3DBORDER</span><span class="space"> </span><span class="sym">=</span><span class="space"> </span><span class="hex">$00000004</span><span class="sym">;</span></pre>
        <pre
            class="line"><span class="linenum">  6</span><span class="space">  </span><span class="ident">DOCHOSTUIFLAG_DIALOG</span><span class="space"> </span><span class="sym">=</span><span class="space"> </span><span class="hex">$00000001</span><span class="sym">;</span></pre>
        <pre
            class="line"><span class="linenum">  7</span><span class="space">  </span><span class="ident">DOCHOSTUIFLAG_THEME</span><span class="space"> </span><span class="sym">=</span><span class="space"> </span><span class="hex">$00040000</span><span class="sym">;</span></pre>
        <pre
            class="line"><span class="linenum">  8</span><span class="space">  </span><span class="ident">DOCHOSTUIFLAG_NOTHEME</span><span class="space"> </span><span class="sym">=</span><span class="space"> </span><span class="hex">$00080000</span><span class="sym">;</span></pre>
        <pre class="line"><span class="linenum">  9</span><span class="kwd">begin</span></pre>
        <pre
            class="line"><span class="linenum"> 10</span><span class="space">  </span><span class="kwd">try</span></pre>
        <pre
            class="line"><span class="linenum"> 11</span><span class="space">    </span><span class="comment">// Clear structure and set size</span></pre>
        <pre
            class="line"><span class="linenum"> 12</span><span class="space">    </span><span class="ident">ZeroMemory</span><span class="sym">(</span><span class="sym">@</span><span class="ident">pInfo</span><span class="sym">,</span><span class="space"> </span><span class="ident">SizeOf</span><span class="sym">(</span><span class="ident">TDocHostUIInfo</span><span class="sym">)</span><span class="sym">)</span><span class="sym">;</span></pre>
        <pre
            class="line"><span class="linenum"> 13</span><span class="space">    </span><span class="ident">pInfo</span><span class="sym">.</span><span class="ident">cbSize</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">SizeOf</span><span class="sym">(</span><span class="ident">TDocHostUIInfo</span><span class="sym">)</span><span class="sym">;</span></pre>
        <pre class="line"><span class="linenum"> 14</span><span class="space">    </span></pre>
        <pre
            class="line"><span class="linenum"> 15</span><span class="space">    </span><span class="comment">// Set scroll bar visibility</span></pre>
        <pre
            class="line"><span class="linenum"> 16</span><span class="space">    </span><span class="kwd">if</span><span class="space"> </span><span class="kwd">not</span><span class="space"> </span><span class="ident">fShowScrollBars</span><span class="space"> </span><span class="kwd">then</span></pre>
        <pre
            class="line"><span class="linenum"> 17</span><span class="space">      </span><span class="ident">pInfo</span><span class="sym">.</span><span class="ident">dwFlags</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">pInfo</span><span class="sym">.</span><span class="ident">dwFlags</span><span class="space"> </span><span class="kwd">or</span><span class="space"> </span><span class="ident">DOCHOSTUIFLAG_SCROLL_NO</span><span class="sym">;</span></pre>
        <pre class="line"><span class="linenum"> 18</span><span class="space">    </span></pre>
        <pre
            class="line"><span class="linenum"> 19</span><span class="space">    </span><span class="comment">// Set border visibility</span></pre>
        <pre
            class="line"><span class="linenum"> 20</span><span class="space">    </span><span class="kwd">if</span><span class="space"> </span><span class="kwd">not</span><span class="space"> </span><span class="ident">fShow3DBorder</span><span class="space"> </span><span class="kwd">then</span></pre>
        <pre
            class="line"><span class="linenum"> 21</span><span class="space">      </span><span class="ident">pInfo</span><span class="sym">.</span><span class="ident">dwFlags</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">pInfo</span><span class="sym">.</span><span class="ident">dwFlags</span><span class="space"> </span><span class="kwd">or</span><span class="space"> </span><span class="ident">DOCHOSTUIFLAG_NO3DBORDER</span><span class="sym">;</span></pre>
        <pre class="line"><span class="linenum"> 22</span><span class="space">    </span></pre>
        <pre
            class="line"><span class="linenum"> 23</span><span class="space">    </span><span class="comment">// Determine if text can be selected</span></pre>
        <pre
            class="line"><span class="linenum"> 24</span><span class="space">    </span><span class="kwd">if</span><span class="space"> </span><span class="kwd">not</span><span class="space"> </span><span class="ident">fAllowTextSelection</span><span class="space"> </span><span class="kwd">then</span></pre>
        <pre
            class="line"><span class="linenum"> 25</span><span class="space">      </span><span class="ident">pInfo</span><span class="sym">.</span><span class="ident">dwFlags</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">pInfo</span><span class="sym">.</span><span class="ident">dwFlags</span><span class="space"> </span><span class="kwd">or</span><span class="space"> </span><span class="ident">DOCHOSTUIFLAG_DIALOG</span><span class="sym">;</span></pre>
        <pre class="line"><span class="linenum"> 26</span><span class="space">        </span></pre>
        <pre
            class="line"><span class="linenum"> 27</span><span class="space">    </span><span class="comment">// Ensure browser uses themes if application is doing so</span></pre>
        <pre
            class="line"><span class="linenum"> 28</span><span class="space">    </span><span class="kwd">if</span><span class="space"> </span><span class="ident">ThemeServices</span><span class="sym">.</span><span class="ident">ThemesEnabled</span><span class="space"> </span><span class="kwd">then</span></pre>
        <pre
            class="line"><span class="linenum"> 29</span><span class="space">      </span><span class="ident">pInfo</span><span class="sym">.</span><span class="ident">dwFlags</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">pInfo</span><span class="sym">.</span><span class="ident">dwFlags</span><span class="space"> </span><span class="kwd">or</span><span class="space"> </span><span class="ident">DOCHOSTUIFLAG_THEME</span></pre>
        <pre
            class="line"><span class="linenum"> 30</span><span class="space">    </span><span class="kwd">else</span><span class="space"> </span><span class="kwd">if</span><span class="space"> </span><span class="ident">ThemeServices</span><span class="sym">.</span><span class="ident">ThemesAvailable</span><span class="space"> </span><span class="kwd">then</span></pre>
        <pre
            class="line"><span class="linenum"> 31</span><span class="space">      </span><span class="ident">pInfo</span><span class="sym">.</span><span class="ident">dwFlags</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">pInfo</span><span class="sym">.</span><span class="ident">dwFlags</span><span class="space"> </span><span class="kwd">or</span><span class="space"> </span><span class="ident">DOCHOSTUIFLAG_NOTHEME</span><span class="sym">;</span></pre>
        <pre class="line"><span class="linenum"> 32</span><span class="space">        </span></pre>
        <pre
            class="line"><span class="linenum"> 33</span><span class="space">    </span><span class="comment">// Record default CSS as Unicode</span></pre>
        <pre
            class="line"><span class="linenum"> 34</span><span class="space">    </span><span class="ident">pInfo</span><span class="sym">.</span><span class="ident">pchHostCss</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">TaskAllocWideString</span><span class="sym">(</span><span class="ident">fCSS</span><span class="sym">)</span><span class="sym">;</span></pre>
        <pre
            class="line"><span class="linenum"> 35</span><span class="space">    </span><span class="kwd">if</span><span class="space"> </span><span class="kwd">not</span><span class="space"> </span><span class="ident">Assigned</span><span class="sym">(</span><span class="ident">pInfo</span><span class="sym">.</span><span class="ident">pchHostCss</span><span class="sym">)</span><span class="space"> </span><span class="kwd">then</span></pre>
        <pre
            class="line"><span class="linenum"> 36</span><span class="space">      </span><span class="kwd">raise</span><span class="space"> </span><span class="ident">Exception</span><span class="sym">.</span><span class="ident">Create</span><span class="sym">(</span></pre>
        <pre
            class="line"><span class="linenum"> 37</span><span class="space">        </span><span class="str">&apos;Task allocator can&apos;&apos;t allocate CSS string&apos;</span></pre>
        <pre
            class="line"><span class="linenum"> 38</span><span class="space">      </span><span class="sym">)</span><span class="sym">;</span></pre>
        <pre class="line"><span class="linenum"> 39</span><span class="space">    </span></pre>
        <pre
            class="line"><span class="linenum"> 40</span><span class="space">    </span><span class="comment">// Return S_OK to indicate we&apos;ve made changes</span></pre>
        <pre
            class="line"><span class="linenum"> 41</span><span class="space">    </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">S_OK</span><span class="sym">;</span></pre>
        <pre
            class="line"><span class="linenum"> 42</span><span class="space">  </span><span class="kwd">except</span></pre>
        <pre
            class="line"><span class="linenum"> 43</span><span class="space">    </span><span class="comment">// Return E_FAIL on error</span></pre>
        <pre
            class="line"><span class="linenum"> 44</span><span class="space">    </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">E_FAIL</span><span class="sym">;</span></pre>
        <pre
            class="line"><span class="linenum"> 45</span><span class="space">  </span><span class="kwd">end</span><span class="sym">;</span><span class="space">  </span></pre>
        <pre class="line"><span class="linenum"> 46</span><span class="kwd">end</span><span class="sym">;</span></pre>
    </div>
    <div class="caption">
        Listing 16
    </div>
    </div>

    <p>
        For our purposes we only need to use the <var>cbSize</var>, <var>dwFlags</var> and <var>pchHostCss</var> fields of <var>TDocHostUIInfo</var>. We set the remaining fields to zero. <var>cbSize</var> is set to the size of the structure &ndash; a common Windows idiom.
    </p>

    <p>
        Next we decide which flags to store in <var>dwFlags</var> to customize the control's user interface capabilities. Which flags we specify depends on the state of the <var>ShowScrollBars</var>, <var>Show3DBorder</var> and <var>AllowTextSelection</var> properties and whether themes are enabled. The flags we use are:
    </p>

    <ul class="wide">
        <li>
            <var>DOCHOSTUIFLAG_SCROLL_NO</var> prevents the vertical scroll bar from being displayed.
        </li>
        <li>
            <var>DOCHOSTUIFLAG_NO3DBORDER</var> inhibits the display of 3D borders.
        </li>
        <li>
            Slightly less obviously, <var>DOCHOSTUIFLAG_DIALOG</var> prevents text selection &ndash; the name comes from the main use of this flag to prevent text selection in dialogue boxes.
        </li>
        <li>
            More complex is the way we ensure that the application's themes are echoed by the web browser control. We use the <var>Themes</var> unit's <var>ThemeServices</var> object to check if themes are enabled. If so we use the <var>DOCHOSTUIFLAG_THEME</var> flag to request that the browser also uses themes. If themes are not enabled, but available, we switch off the browser's theme support by using <var>DOCHOSTUIFLAG_NOTHEME</var>. If themes are not available at all (e.g. in Windows 2000) we do nothing.
        </li>
    </ul>

    <div class="callout callout-info">
        <h4>
            Other flags
        </h4>
        <p>
            There are numerous other <var>DOCHOSTUIFLAG_</var> flags that can be assigned to <var>dwFlags</var>. The full set is defined in this article's <a href="#demo-code">demo code</a>.
        </p>
    </div>

    <p>
        Lastly, we store the default style sheet (per the <var>CSS</var> property) as Unicode text in the <var>pchHostCss</var> field. We have to allocate storage for this Unicode string &ndash; and we <strong>must</strong> use the task allocator to do this. Note that we are not responsible for freeing this memory &ndash; <var>TWebBrowser</var> does this.
    </p>

    <p>
        We use the <var>TaskAllocWideString</var> helper function (taken from the DelphiDabbler <a href="https://github.com/delphidabbler/code-snippets/tree/master/csdb">Code Snippets Database</a>) to allocate the storage and ensure the string is in Unicode format. The routine is shown in <span class="figureref">Listing 17</span>. Note that this code works on both Unicode and non-Unicode Delphis.
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre
                class="line"><span class="linenum">  1</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TaskAllocWideString</span><span class="sym">(</span><span class="kwd">const</span><span class="space"> </span><span class="ident">S</span><span class="sym">:</span><span class="space"> </span><span class="kwd">string</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="ident">PWChar</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">  2</span><span class="kwd">var</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">  </span><span class="ident">StrLen</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">;</span><span class="space">  </span><span class="comment">// length of string in bytes</span></pre>
            <pre class="line"><span class="linenum">  4</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">  5</span><span class="space">  </span><span class="comment">// Store length of string in characters, allowing for terminal #0</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="space">  </span><span class="ident">StrLen</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">Length</span><span class="sym">(</span><span class="ident">S</span><span class="sym">)</span><span class="space"> </span><span class="sym">+</span><span class="space"> </span><span class="num">1</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  7</span><span class="space">  </span><span class="comment">// Allocate buffer for wide string using task allocator</span></pre>
            <pre
                class="line"><span class="linenum">  8</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">CoTaskMemAlloc</span><span class="sym">(</span><span class="ident">StrLen</span><span class="space"> </span><span class="sym">*</span><span class="space"> </span><span class="ident">SizeOf</span><span class="sym">(</span><span class="ident">WideChar</span><span class="sym">)</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  9</span><span class="space">  </span><span class="kwd">if</span><span class="space"> </span><span class="ident">Assigned</span><span class="sym">(</span><span class="ident">Result</span><span class="sym">)</span><span class="space"> </span><span class="kwd">then</span></pre>
            <pre
                class="line"><span class="linenum"> 10</span><span class="space">    </span><span class="comment">// Convert string to wide string and store in buffer</span></pre>
            <pre
                class="line"><span class="linenum"> 11</span><span class="space">    </span><span class="ident">StringToWideChar</span><span class="sym">(</span><span class="ident">S</span><span class="sym">,</span><span class="space"> </span><span class="ident">Result</span><span class="sym">,</span><span class="space"> </span><span class="ident">StrLen</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 12</span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 17
        </div>
    </div>


    <p>
        And that completes the browser customization code. If you need to specify different customizations simply define a new class that descends from <var>TNulWBContainer</var> and provide the required functionality by re-implementing the appropriate <var>IDocHostUIHandler</var> methods.
    </p>

    <div class="callout callout-info">
        <h4>
            Other examples
        </h4>
        <p>
            <a href="./article-22">Article #22</a>: &quot;How to call Delphi code from scripts running in a TWebBrowser&quot; demonstrates another class that descends from <var>TNulWBContainer</var>, this time re-implementing the <var>GetExternal</var> method.
        </p>
    </div>

    <p>
        To use our customization class simply create an instance of <var>TWBContainer</var>, passing a reference to the browser control that is to be customized, set the required properties of <var>TWBContainer</var> then load the required document.
    </p>

    <div class="callout callout-warning">
        <h4>
            Note for legacy OSs
        </h4>
        <p>
            You should always set the properties of <var>TWBContainer</var> before loading any document into the browser control. The reason for this is that on operating systems earlier than Windows XP SP2 the control only reads the default CSS when the first document is loaded. Changing the <var>CSS</var> property after loading the first document will have no effect.
        </p>
    </div>

</section>

<!-- 18-5.inc -->

<section id="sample-app">

    <h2>
        Exercising the code &ndash; a sample application
    </h2>

    <p>
        One of the problems that motivated this exploration was my need to use a <var>TWebBrowser</var> to display some HTML in a dialogue box. The HTML needed to look and behave as if it was part of the dialogue box, which could be using themes. The dialogue box would also need to display a custom pop-up menu.
    </p>

    <p>
        This sample application will emulate such a dialogue box. It will use our custom <var>TWBContainer</var> to take control over the appearance of a <var>TWebBrowser</var> control. This will not be production code &ndash; for example we load the HTML from a file and we wouldn't do that in released code &ndash; but it should suffice to demonstrate that the customization class works.
    </p>

    <p>
        The application will be developed in two stages. Stage one will be the bare application with no <var>TWebBrowser</var> customization code. We will run the program to check what it looks like in its natural state before we intervene. In stage two we'll apply the classes we've developed here and see the difference.
    </p>


    <h3 id="stage1">
        Stage 1
    </h3>

    <p>
        Open a new Delphi project and select the main form, then:
    </p>

    <ul class="wide">
        <li>
            Give the form a <var>BorderStyle</var> of <var>bsDialog</var>.
        </li>

        <li>
            <p>
                Place a <var>TButton</var> centred at the bottom of the form, set its <var>Caption</var> to 'Close' and create an <var>OnClick</var> event handler for it containing just the code shown in <span class="figureref">Listing 18</span>:
            </p>
            <div class="frame">
                <div class="code-pascal">
                    <pre
                        class="line"><span class="linenum">  1</span><span class="kwd">procedure</span><span class="space"> </span><span class="ident">TForm1</span><span class="sym">.</span><span class="ident">Button1Click</span><span class="sym">(</span><span class="ident">Sender</span><span class="sym">:</span><span class="space"> </span><span class="ident">TObject</span><span class="sym">)</span><span class="sym">;</span></pre>
                    <pre class="line"><span class="linenum">  2</span><span class="kwd">begin</span></pre>
                    <pre
                        class="line"><span class="linenum">  3</span><span class="space">  </span><span class="ident">Close</span><span class="sym">;</span><span class="space">  </span><span class="comment">// close the application</span></pre>
                    <pre
                        class="line"><span class="linenum">  4</span><span class="kwd">end</span><span class="sym">;</span></pre>
                </div>
                <div class="caption">
                    Listing 18
                </div>
            </div>
        </li>

        <li>
            Add a <var>TPopupMenu</var> and give it a single menu item with <var>Caption</var> set to 'Show the CSS'.
        </li>

        <li>
            Drop a <var>TWebBrowser</var> control, set its <var>Align</var> property to <var>alTop</var> and size it to take up most of the form. Leave room for the 'Close' button below it. Set its <var>PopupMenu</var> property to <var>PopupMenu1</var>.
        </li>

        <li>
            Add the <var>XPMan</var> unit (Delphi 7 and later) to the form's <var>uses</var> clause to ensure the application displays themes if available. <strong>Note:</strong> This may not be necessary with later Delphis that can enable themes by default in the project resource file.
        </li>
    </ul>

    <p>
        Now, double-click the form to open a new <var>OnCreate</var> event handler and enter the code shown in <span class="figureref">Listing 19</span>. This loads the HTML file into the browser:
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre
                class="line"><span class="linenum">  1</span><span class="kwd">procedure</span><span class="space"> </span><span class="ident">TForm1</span><span class="sym">.</span><span class="ident">FormCreate</span><span class="sym">(</span><span class="ident">Sender</span><span class="sym">:</span><span class="space"> </span><span class="ident">TObject</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  2</span><span class="kwd">begin</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">  </span><span class="comment">// load content</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="space">  </span><span class="ident">WebBrowser1</span><span class="sym">.</span><span class="ident">Navigate</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum">  5</span><span class="space">    </span><span class="ident">ExtractFilePath</span><span class="sym">(</span><span class="ident">ParamStr</span><span class="sym">(</span><span class="num">0</span><span class="sym">)</span><span class="sym">)</span><span class="space"> </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;DlgContent.html&apos;</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="space">  </span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum">  7</span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 19
        </div>
    </div>

    <p>
        Finally create the HTML file, <code>DlgContent.html</code>, that is loaded in <var>FormCreate</var> above. This file will provide the content of our dialogue box. <span class="figureref">Listing 20</span> shows the HTML.
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre class="line"><span class="linenum">  1</span><span class="kwd">&lt;html&gt;</span></pre>
            <pre class="line"><span class="linenum">  2</span>  <span class="kwd">&lt;head&gt;</span></pre>
            <pre
                class="line"><span class="linenum">  3</span>    <span class="kwd">&lt;title&gt;</span>Demo Dialogue Content</span><span class="kwd">&lt;/title&gt;</span></pre>
            <pre
                class="line"><span class="linenum">  4</span>    <span class="kwd">&lt;script</span> <span class="ident">type</span><span class="sym">=</span>&quot;text/javascript&quot;<span class="kwd">&gt;</span></pre>
            <pre class="line"><span class="linenum">  5</span>      function ViewArticle() {</pre>
            <pre class="line"><span class="linenum">  6</span>        wdw = window.open();</pre>
            <pre class="line"><span class="linenum">  7</span>        wdw.document.location =</pre>
            <pre
                class="line"><span class="linenum">  8</span>          &quot;https://delphidabbler.com/articles/article-18&quot;;</pre>
            <pre class="line"><span class="linenum">  9</span>      }</pre>
            <pre class="line"><span class="linenum"> 10</span>    <span class="kwd">&lt;/script&gt;</span></pre>
            <pre class="line"><span class="linenum"> 11</span>  <span class="kwd">&lt;/head&gt;</span></pre>
            <pre class="line"><span class="linenum"> 12</span>  <span class="kwd">&lt;body&gt;</span></pre>
            <pre class="line"><span class="linenum"> 13</span>    <span class="kwd">&lt;h1&gt;</span></pre>
            <pre class="line"><span class="linenum"> 14</span>      About this demo</pre>
            <pre class="line"><span class="linenum"> 15</span>    <span class="kwd">&lt;/h1&gt;</span></pre>
            <pre class="line"><span class="linenum"> 16</span>    <span class="kwd">&lt;p&gt;</span></pre>
            <pre
                class="line"><span class="linenum"> 17</span>      This demo relates to the DelphiDabbler.com article &amp;quot;How to</pre>
            <pre
                class="line"><span class="linenum"> 18</span>      customise the TWebBrowser user interface &amp;quot;.</pre>
            <pre class="line"><span class="linenum"> 19</span>      <span class="kwd">&lt;input</span></pre>
            <pre
                class="line"><span class="linenum"> 20</span>        <span class="ident">type</span><span class="sym">=</span>&quot;button&quot;</pre>
            <pre
                class="line"><span class="linenum"> 21</span>        <span class="ident">name</span><span class="sym">=</span>&quot;button&quot;</pre>
            <pre
                class="line"><span class="linenum"> 22</span>        <span class="ident">id</span><span class="sym">=</span>&quot;button&quot;</pre>
            <pre
                class="line"><span class="linenum"> 23</span>        <span class="ident">value</span><span class="sym">=</span>&quot;View article...&quot;</pre>
            <pre
                class="line"><span class="linenum"> 24</span>        <span class="ident">onclick</span><span class="sym">=</span>&quot;ViewArticle();&quot;</pre>
            <pre class="line"><span class="linenum"> 25</span>      <span class="kwd">/&gt;</span></pre>
            <pre class="line"><span class="linenum"> 26</span>    <span class="kwd">&lt;/p&gt;</span></pre>
            <pre class="line"><span class="linenum"> 27</span>    <span class="kwd">&lt;p&gt;</span></pre>
            <pre class="line"><span class="linenum"> 28</span>      &amp;copy; Copyright P D Johnson</pre>
            <pre
                class="line"><span class="linenum"> 29</span>      (<span class="kwd">&lt;a</span> <span class="ident">href</span><span class="sym">=</span>&quot;https://delphidabbler.com/&quot;</pre>
            <pre
                class="line"><span class="linenum"> 30</span>      <span class="ident">target</span><span class="sym">=</span>&quot;_blank&quot;<span class="kwd">&gt;</span>delphidabbler.com<span class="kwd">&lt;/a&gt;</span>), 2004-2022.</pre>
            <pre class="line"><span class="linenum"> 31</span>    <span class="kwd">&lt;/p&gt;</span></pre>
            <pre
                class="line"><span class="linenum"> 32</span>    <span class="kwd">&lt;p</span> <span class="ident">class</span><span class="sym">=</span>&quot;ruled&quot;<span class="kwd">&gt;</span></pre>
            <pre
                class="line"><span class="linenum"> 33</span>      Right click above the line to see the custom pop-up menu.</pre>
            <pre class="line"><span class="linenum"> 34</span>    <span class="kwd">&lt;/p&gt;</span></pre>
            <pre class="line"><span class="linenum"> 35</span>  <span class="kwd">&lt;/body&gt;</span></pre>
            <pre class="line"><span class="linenum"> 36</span><span class="kwd">&lt;/html&gt;</span></pre>
        </div>
        <div class="caption">
            Listing 20
        </div>
    </div>

    <p>
        This code defines a document which has:
    </p>

    <ul>
        <li>
            Some plain text including a paragraph styled using a CSS class named <var>.ruled</var> that is not defined in the document.
        </li>
        <li>
            A button that, when clicked, runs some JavaScript that opens a new window and displays this article in it.
        </li>
        <li>
            Some clickable text that opens a new browser window and navigates to the <span class="ddab">DelphiDabbler.com</span> home page.
        </li>
    </ul>

    <p>
        If you compile and run this application then right click in the browser control you should see something like this:
    </p>

    <div class="frame">
        <div>
            <img class="scale center-block"
                src="{{ site.base-url }}{{ site.data.core.articles-images-base-url}}/18-1.gif" width="390" height="355"
                alt="TWebBrowser showing normal UI and context menu on Windows XP"
                title="TWebBrowser showing normal UI and context menu on Windows XP" />
        </div>
        <div class="caption">
            Image 1: TWebBrowser showing normal UI
        </div>
    </div>

    <p>
        Doesn't look much like a dialogue box does it? There are numerous problems:
    </p>

    <ol class="wide">
        <li>
            The browser control is displaying its default border and scroll bar.
        </li>
        <li>
            The HTML is being displayed in the default style.
        </li>
        <li>
            The form's 'Close' button is themed while the 'View article' button displayed by the browser control is not.
        </li>
        <li>
            Despite setting the <var>PopupMenu</var> property, the standard browser's context menu is still displayed.
        </li>
        <li>
            Although it can't be seen here, you could select the text in the HTML document.
        </li>
    </ol>

    <p>
        Let us now adapt the program to correct all these problems.
    </p>


    <h3 id="stage2">
        Stage 2
    </h3>

    <p>
        We will now utilize the classes we have developed in this article. To begin with add the units containing <var>IDocHOstUIHandler</var>, <var>TNulWBContainer</var> and <var>TWBContainer</var> to the project and refer to them in the main form's uses clause. Also add the <var>ActiveX</var> and <var>SysUtils</var> units to the uses clause.
    </p>

    <p>
        It's now time to set up and use the container object. Switch to the form unit we developed in <a href="#stage1">Stage 1</a> and add a field named <var>fWBContainer</var> of type <var>TWBContainer</var> to the form's class declaration. Now rewrite the form's <var>OnCreate</var> event handler as shown in <span class="figureref">Listing 21</span>.
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre
                class="line"><span class="linenum">  1</span><span class="kwd">procedure</span><span class="space"> </span><span class="ident">TForm1</span><span class="sym">.</span><span class="ident">FormCreate</span><span class="sym">(</span><span class="ident">Sender</span><span class="sym">:</span><span class="space"> </span><span class="ident">TObject</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">  2</span><span class="kwd">const</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">  </span><span class="comment">// Template for default CSS style</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="space">  </span><span class="ident">cCSSTplt</span><span class="space"> </span><span class="sym">=</span><span class="space"> </span><span class="str">&apos;body {&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum">  5</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;    background-color: %0:s;&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum">  6</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;    color: %1:s;&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum">  7</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;    font-family: &quot;%2:s&quot;;&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum">  8</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;    font-size: %3:dpt;&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum">  9</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;    margin: 4px;&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum"> 10</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;}&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum"> 11</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;h1 {&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum"> 12</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;    font-size: %3:dpt;&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum"> 13</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;    font-weight: bold;&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum"> 14</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;    text-align: center;&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum"> 15</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;}&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum"> 16</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;input#button {&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum"> 17</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;    color: %1:s;&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum"> 18</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;    font-family: &quot;%2:s&quot;;&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum"> 19</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;    font-size: %3:dpt;&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum"> 20</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;}&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum"> 21</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;.ruled {&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum"> 22</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;    border-bottom: %4:s solid 2px;&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum"> 23</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;    padding-bottom: 6px;&apos;</span><span class="str">#13</span><span class="str">#10</span></pre>
            <pre
                class="line"><span class="linenum"> 24</span><span class="space">    </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;}&apos;</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum"> 25</span><span class="kwd">var</span></pre>
            <pre
                class="line"><span class="linenum"> 26</span><span class="space">  </span><span class="ident">FmtCSS</span><span class="sym">:</span><span class="space"> </span><span class="kwd">string</span><span class="sym">;</span><span class="space">  </span><span class="comment">// Stores default CSS</span></pre>
            <pre class="line"><span class="linenum"> 27</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum"> 28</span><span class="space">  </span><span class="comment">// Create the CSS from system colours</span></pre>
            <pre
                class="line"><span class="linenum"> 29</span><span class="space">  </span><span class="ident">FmtCSS</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">Format</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 30</span><span class="space">    </span><span class="ident">cCSSTplt</span><span class="sym">,</span></pre>
            <pre
                class="line"><span class="linenum"> 31</span><span class="space">    </span><span class="sym">[</span><span class="ident">ColorToHTML</span><span class="sym">(</span><span class="ident">Self</span><span class="sym">.</span><span class="ident">Color</span><span class="sym">)</span><span class="sym">,</span><span class="space"> </span><span class="ident">ColorToHTML</span><span class="sym">(</span><span class="ident">Self</span><span class="sym">.</span><span class="ident">Font</span><span class="sym">.</span><span class="ident">Color</span><span class="sym">)</span><span class="sym">,</span></pre>
            <pre
                class="line"><span class="linenum"> 32</span><span class="space">    </span><span class="ident">Self</span><span class="sym">.</span><span class="ident">Font</span><span class="sym">.</span><span class="ident">Name</span><span class="sym">,</span><span class="space"> </span><span class="ident">Self</span><span class="sym">.</span><span class="ident">Font</span><span class="sym">.</span><span class="ident">Size</span><span class="sym">,</span></pre>
            <pre
                class="line"><span class="linenum"> 33</span><span class="space">    </span><span class="ident">ColorToHTML</span><span class="sym">(</span><span class="ident">clInactiveCaption</span><span class="sym">)</span><span class="sym">]</span></pre>
            <pre
                class="line"><span class="linenum"> 34</span><span class="space">  </span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 35</span><span class="space">  </span><span class="comment">// Create web browser container and set required properties</span></pre>
            <pre
                class="line"><span class="linenum"> 36</span><span class="space">  </span><span class="ident">fWBContainer</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">TWBContainer</span><span class="sym">.</span><span class="ident">Create</span><span class="sym">(</span><span class="ident">WebBrowser1</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 37</span><span class="space">  </span><span class="ident">fWBContainer</span><span class="sym">.</span><span class="ident">UseCustomCtxMenu</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">True</span><span class="sym">;</span><span class="space">    </span><span class="comment">// use our popup menu</span></pre>
            <pre
                class="line"><span class="linenum"> 38</span><span class="space">  </span><span class="ident">fWBContainer</span><span class="sym">.</span><span class="ident">Show3DBorder</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">False</span><span class="sym">;</span><span class="space">       </span><span class="comment">// no border</span></pre>
            <pre
                class="line"><span class="linenum"> 39</span><span class="space">  </span><span class="ident">fWBContainer</span><span class="sym">.</span><span class="ident">ShowScrollBars</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">False</span><span class="sym">;</span><span class="space">     </span><span class="comment">// no scroll bars</span></pre>
            <pre
                class="line"><span class="linenum"> 40</span><span class="space">  </span><span class="ident">fWBContainer</span><span class="sym">.</span><span class="ident">AllowTextSelection</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">False</span><span class="sym">;</span><span class="space"> </span><span class="comment">// no text selection</span></pre>
            <pre
                class="line"><span class="linenum"> 41</span><span class="space">  </span><span class="ident">fWBContainer</span><span class="sym">.</span><span class="ident">CSS</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">FmtCSS</span><span class="sym">;</span><span class="space">               </span><span class="comment">// CSS to be used</span></pre>
            <pre
                class="line"><span class="linenum"> 42</span><span class="space">  </span><span class="comment">// load content</span></pre>
            <pre
                class="line"><span class="linenum"> 43</span><span class="space">  </span><span class="ident">fWBContainer</span><span class="sym">.</span><span class="ident">HostedBrowser</span><span class="sym">.</span><span class="ident">Navigate</span><span class="sym">(</span></pre>
            <pre
                class="line"><span class="linenum"> 44</span><span class="space">    </span><span class="ident">ExtractFilePath</span><span class="sym">(</span><span class="ident">ParamStr</span><span class="sym">(</span><span class="num">0</span><span class="sym">)</span><span class="sym">)</span><span class="space"> </span><span class="sym">+</span><span class="space"> </span><span class="str">&apos;DlgContent.html&apos;</span></pre>
            <pre
                class="line"><span class="linenum"> 45</span><span class="space">  </span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre
                class="line"><span class="linenum"> 46</span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 21
        </div>
    </div>

    <p>
        Key points to note in this method are:
    </p>

    <ul class="wide">
        <li>
            First we provide a template for a cascading style sheet we will use to make the HTML take on the appearance of the dialogue box. This template includes some format strings as placeholders for colour and font information that will be filled in at run time.
        </li>

        <li>
            <p>
                Next we fill in the required values in the CSS template and store the resulting code in <var>FmtCSS</var>. We get the colours and font from various properties of the form and from suitable system colours. Note that we use the <var>ColorToHTML</var> helper function (taken from the <a href="https://github.com/delphidabbler/code-snippets/tree/master/csdb">Code Snippets Database</a>) to format colour information correctly:
            </p>
            <div class="frame">
                <div class="code-pascal">
                    <pre
                        class="line"><span class="linenum">  1</span><span class="kwd">function</span><span class="space"> </span><span class="ident">ColorToHTML</span><span class="sym">(</span><span class="kwd">const</span><span class="space"> </span><span class="ident">Color</span><span class="sym">:</span><span class="space"> </span><span class="ident">TColor</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="kwd">string</span><span class="sym">;</span></pre>
                    <pre class="line"><span class="linenum">  2</span><span class="kwd">var</span></pre>
                    <pre
                        class="line"><span class="linenum">  3</span><span class="space">  </span><span class="ident">ColorRGB</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">;</span></pre>
                    <pre class="line"><span class="linenum">  4</span><span class="kwd">begin</span></pre>
                    <pre
                        class="line"><span class="linenum">  5</span><span class="space">  </span><span class="ident">ColorRGB</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">ColorToRGB</span><span class="sym">(</span><span class="ident">Color</span><span class="sym">)</span><span class="sym">;</span></pre>
                    <pre
                        class="line"><span class="linenum">  6</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">Format</span><span class="sym">(</span></pre>
                    <pre
                        class="line"><span class="linenum">  7</span><span class="space">    </span><span class="str">&apos;#%0.2X%0.2X%0.2X&apos;</span><span class="sym">,</span></pre>
                    <pre
                        class="line"><span class="linenum">  8</span><span class="space">    </span><span class="sym">[</span><span class="ident">GetRValue</span><span class="sym">(</span><span class="ident">ColorRGB</span><span class="sym">)</span><span class="sym">,</span><span class="space"> </span><span class="ident">GetGValue</span><span class="sym">(</span><span class="ident">ColorRGB</span><span class="sym">)</span><span class="sym">,</span><span class="space"> </span><span class="ident">GetBValue</span><span class="sym">(</span><span class="ident">ColorRGB</span><span class="sym">)</span><span class="sym">]</span></pre>
                    <pre
                        class="line"><span class="linenum">  9</span><span class="space">  </span><span class="sym">)</span><span class="sym">;</span></pre>
                    <pre
                        class="line"><span class="linenum"> 10</span><span class="kwd">end</span><span class="sym">;</span></pre>
                </div>
                <div class="caption">
                    Listing 22
                </div>
            </div>
        </li>

        <li>
            Next we create the container object, passing the hosted <var>TWebBrowser</var> as a parameter, then set the properties as required.
        </li>

        <li>
            Finally we revert to the original code and load the document, except that we use the container object's <var>HostedBrowser</var> property to access the browser control rather than accessing it directly.
        </li>
    </ul>

    <p>
        A couple more things remain to be done. The first is to handle the form's <var>OnDestroy</var> event to free the container object, as shown in <span class="figureref">Listing 23</span>.
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre
                class="line"><span class="linenum">  1</span><span class="kwd">procedure</span><span class="space"> </span><span class="ident">TForm1</span><span class="sym">.</span><span class="ident">FormDestroy</span><span class="sym">(</span><span class="ident">Sender</span><span class="sym">:</span><span class="space"> </span><span class="ident">TObject</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">  2</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">  </span><span class="ident">fWBContainer</span><span class="sym">.</span><span class="ident">Free</span><span class="sym">;</span><span class="space">  </span><span class="comment">// free the container pbject</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 23
        </div>
    </div>

    <p>
        Finally we need to handle the <var>OnClick</var> event of our single context menu item. All we do here is display the default CSS in a message box, as <span class="figureref">Listing 24</span> illustrates.
    </p>

    <div class="frame">
        <div class="code-pascal">
            <pre
                class="line"><span class="linenum">  1</span><span class="kwd">procedure</span><span class="space"> </span><span class="ident">TForm1</span><span class="sym">.</span><span class="ident">ShowtheCSS1Click</span><span class="sym">(</span><span class="ident">Sender</span><span class="sym">:</span><span class="space"> </span><span class="ident">TObject</span><span class="sym">)</span><span class="sym">;</span></pre>
            <pre class="line"><span class="linenum">  2</span><span class="kwd">begin</span></pre>
            <pre
                class="line"><span class="linenum">  3</span><span class="space">  </span><span class="ident">ShowMessage</span><span class="sym">(</span><span class="ident">fWBContainer</span><span class="sym">.</span><span class="ident">CSS</span><span class="sym">)</span><span class="sym">;</span><span class="space">  </span><span class="comment">// display the CSS code</span></pre>
            <pre
                class="line"><span class="linenum">  4</span><span class="kwd">end</span><span class="sym">;</span></pre>
        </div>
        <div class="caption">
            Listing 24
        </div>
    </div>

    <p>
        The moment of truth arrives. Let's run the revised application and see if it all works. Here's what we see on Windows XP with themes enabled:
    </p>

    <div class="frame">
        <div>
            <img class="scale center-block"
                src="{{ site.base-url }}{{ site.data.core.articles-images-base-url}}/18-2.gif" width="386" height="208"
                alt="User-styled, themed, TWebBrowser showing custom context menu on Windows XP"
                title="User-styled, themed, TWebBrowser showing custom context menu on Windows XP" />
        </div>
        <div class="caption">
            Image 2: User-styled, themed, TWebBrowser showing custom context menu
        </div>
    </div>

    <p>
        Notice that:
    </p>

    <ul>
        <li>
            The borders and scroll bar have gone.
        </li>
        <li>
            The HTML is displayed in the correct dialogue box font and colours.
        </li>
        <li>
            The 'View article' button is correctly themed.
        </li>
        <li>
            The paragraph with the <var>.ruled</var> CSS class now has a bottom border in the same colour as an inactive caption.
        </li>
        <li>
            Right clicking displays the single menu item of the <var>TPopupMenu</var> we assigned to the browser control's <var>PopupMenu</var> property.
        </li>
        <li>
            Take it on trust that you can't select text either!
        </li>
    </ul>

    <p>
        Just to show that the browser control correctly adopts the current dialogue box style, here is the same application running unchanged in on Windows XP using its classic style with the <em>Spruce</em> colour scheme:
    </p>

    <div class="frame">
        <div>
            <img class="scale center-block"
                src="{{ site.base-url }}{{ site.data.core.articles-images-base-url}}/18-3.gif" width="386" height="201"
                alt="User-styled, un-themed, TWebBrowser showing custom context menu on Windows XP using the Classic style"
                title="User-styled, un-themed, TWebBrowser showing custom context menu on Windows XP using the Classic style" />
        </div>
        <div class="caption">
            Image 2: User-styled, un-themed, TWebBrowser showing custom context menu
        </div>
    </div>

    <p>
        All the code has now been completed. The source code can be <a href="#demo-code">downloaded below</a>.
    </p>

</section>

<!-- 18-6.inc -->

<section id="demo-code">

    <h2>
        Demo Code
    </h2>

    <p>
        A demo program to accompany this article can be found in the <code><a href="https://github.com/delphidabbler/article-demos">delphidabbler/article-demos</a></code> Git repository on GitHub.
    </p>

    <p>
        You can view the code in the <code><a href="https://github.com/delphidabbler/article-demos/tree/master/article-18">article-18</a></code> sub-directory. Alternatively download a zip file containing all the demos by going to the repository's landing page and clicking the <em>Clone or download</em> button and selecting <em>Download ZIP</em>.
    </p>

    <p>
        The demo includes the following:
    </p>

    <ul class="wide">
        <li>
            Two applications &ndash; <code>WBUIArtDemo1.exe</code> and <code>WBUIArtDemo2.exe</code> &ndash; that include Delphi code for stages 1 and 2 of the sample application.
        </li>
        <li>
            Separate units containing the null and custom container classes &ndash; <code>UNulContainer.pas</code> and <code>UContainer.pas</code>.
        </li>
        <li>
            <code>IntfDocHostUIHandler.pas</code> that contains the declaration of <var>IDocHostUIHandler</var>, associated structures and all the <var>DOCHOSTUIFLAG_</var> flags.
        </li>
    </ul>

    <p>
        This code has been tested with Delphi 7, 2006 and 2010 on Windows XP Pro and Internet Explorer 6 and on Windows Vista Home Premium with Internet Explorer 8.
    </p>

    <div class="callout callout-info">
        <p>
            <span class="fa fa-code fa-x-pad-right fa-2x fa-pull-left fa-border text-muted"></span>This source code is merely a proof of concept and is intended only to illustrate this article. It is not designed for use in its current form in finished applications. The code is provided on an &quot;AS IS&quot; basis, WITHOUT WARRANTY OF ANY KIND, either express or implied.
        </p>
        <p>
            The demo code is licensed under the <a href="https://github.com/delphidabbler/article-demos/blob/master/LICENSE.md">MIT License</a>, except for <code>IntfDocHostUIHandler.pas</code> which is licensed under the MPL / GPL / LGPL tri-license.
        </p>
    </div>

</section>

<section id="summary">

    <h2>
        Summary
    </h2>

    <p>
        In this article we have investigated how to customize the appearance of a <var>TWebBrowser</var> control.
    </p>

    <p>
        We noted that we can control the appearance and behaviour of <var>TWebBrowser</var> by developing a container object that implements the <var>IDocHostUIHandler</var> interface. In order for the browser control to find the <var>IDocHostUIHandler</var> implementation we also needed to implement <var>IOleClientSite</var>.
    </p>

    <p>
        We first created a reusable, &quot;do nothing&quot; container class that provided a minimal implementation of the required interfaces. Then we derived a custom class from the &quot;do nothing&quot; container that provided the required customization. We also exposed properties to enable users to manipulate the browser's appearance and behaviour. Finally we developed a sample application to exercise the customizable container.
    </p>

    <p>
        A downloadable demo program was made available that includes all the code discussed in the article.
    </p>

</section>

<section id="references">

    <h2>
        References
    </h2>

    <p>
        Several references from MSDN were used in researching this article. They are:
    </p>

    <ul>
        <li>
            <a href="https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/aa741313(v=vs.85)">About the Browser</a>
        </li>
        <li>
            <a href="https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/aa770041(v=vs.85)">WebBrowser Customization</a>
        </li>
        <li>
            <a href="https://docs.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/aa753260(v=vs.85)">IDocHostUIHandler Interface</a>
        </li>
        <li>
            <a href="https://docs.microsoft.com/en-gb/windows/win32/api/oleidl/nn-oleidl-ioleclientsite">IOleClientSite Interface</a>
        </li>
    </ul>

</section>

<section id="feedback">

    <h2>
        Feedback
    </h2>

    <p>
        I hope you enjoyed this article and found it useful.
    </p>

    <p>
        If you have any observations, comments or have found any errors there are two places you the please raise an issue in one of two places:
    </p>

    <ol class="wide">
        <li>
            For anything to do with the article content please use this website's <a href="https://github.com/delphidabbler/delphidabbler.github.io/issues">Issues page</a>, making sure you mention &quot;Article #18&quot;.
        </li>
        <li>
            If you've found a bug in the downloaded source code please report it on the <code>delphidabbler/article-demos</code> <a href="https://github.com/delphidabbler/article-demos/issues">Issues page</a>. Again mention &quot;Article #18&quot;.
        </li>
    </ol>

</section>
