---
article: 11
title: "How to catch files dragged and dropped on an application from Explorer"
summary: "A guide to using the Windows API to catch and process files dropped from Windows Explorer."
meta-title: "Use Delphi Pascal to handle drag & drop from Windows Explorer | How to"
meta-desc: "An article that uses Delphi Pascal to illustrate how to programatically handle drag and drop from Windows Explorer."
index: true
redirect_from:
- /articles/11
---
<section id="contents">

	<h2>Contents</h2>

	<nav>
		<div class="well">
			<ul>
				<li><a href="#rationale">Why do it?</a></li>
				<li><a href="#explain">How it's done</a>
					<ul>
						<li><a href="#overview">Overview</a></li>
						<li><a href="#getinfo">Getting information about dropped files</a></li>
						<li><a href="#solution">Putting it all together</a></li>
						<li><a href="#delphiway">The Delphi way</a></li>
						<li><a href="#gofurther">Going further</a></li>
					</ul>
				</li>
				<li><a href="#demo">Demo application</a></li>
				<li><a href="#feedback">Feedback</a></li>
			</ul>
		</div>
	</nav>

</section>

<section id="rationale">

	<h2>Why do it?</h2>

	<p>Many programs allow the user to open files by dragging them from Explorer and dropping them on the program's window. This is often more convenient to the user than using the normal <em>File | Open</em> menu option or toolbar button, since it misses out the step of navigating an <em>Open File</em> dialog box. Adding similar support to your program makes it appear more professional.</p>

</section>


<section id="explain">

	<h2>How it's done</h2>

	<p>There are two main ways to add support to a Windows application. The first is to use Windows drag and drop API functions and handle a related Windows message. The second method uses OLE (COM), and additionally supports inter and intra-application drag and drop. We'll explore the first, and most simple, of these methods here.</p>

	<aside>
		<p class="callout callout-info glyph">OLE drag and drop is explored in the article &quot;<a href="/articles/article-24">How to receive data dragged from other applications</a>&quot;.</p>
	</aside>


	<h3 id="overview">Overview</h3>

	<p>File drag and drop is not enabled in Windows applications by default. To support it we need to tell Windows we want to be notified about file drops, and nominate a window to receive the notifications. The nominated window has to handle the <var>WM_DROPFILES</var> message that Windows sends us when a drop occurs. The message supplies us with a &quot;drop handle&quot; that we pass to various API routines to get information about what was dropped. When we've finished good manners require that we tell Windows we no longer need to be told about drops.</p>

	<aside>
		<div id="vistaproblem" class="callout callout-warning">

			<h4>Security Issues (Windows Vista and later)</h4>

			<p>For security reasons Windows Vista and later may disallow drag and drop between windows that have different security permissions. As a consequence
				<var>WM_DROPFILES</var> messages may be blocked.
			</p>

			<p class="strong"><span class="fa-stack fa-lg"><span class="fa fa-bug fa-stack-1x"></span><span class="fa fa-ban fa-stack-2x text-danger"></span></span> If you run into this problem note that it is a feature of Windows, not a bug in the code!</p>

			<p>You can read more about the problem on this <a href="http://forums.microsoft.com/MSDN/ShowPost.aspx?PostID=736086&amp;SiteID=1">Microsoft forum</a></p>

		</div>
	</aside>

	<p>Here is a step by step guide to what we need to do in a Delphi application to handle dropped files:</p>

	<ol class="wide">

		<li>
			<p>Use the <code>ShellAPI</code> unit to get access to the required API routines:</p>
			<div id="listing-1" class="frame">
				<div class="code-pascal">
					<pre class="line"><span class="kwd">uses</span><span class="space"> </span><span class="ident">ShellAPI</span></pre>
				</div>
				<div class="caption">Listing 1</div>
			</div>
		</li>

		<li>
			<p>Call <var>DragAcceptFiles</var>, passing the handle of the window that is to receive <var>WM_DROPFILES</var> messages, along with a flag to indicate we want to receive notifications. For example, for our main program form to receive the messages use:</p>
			<div id="listing-2" class="frame">
				<div class="code-pascal">
					<pre class="line"><span class="ident">DragAcceptFiles</span><span class="sym">(</span><span class="ident">Form1</span><span class="sym">.</span><span class="ident">Handle</span><span class="sym">,</span><span class="space"> </span><span class="ident">True</span><span class="sym">)</span><span class="sym">;</span></pre>
				</div>
				<div class="caption">Listing 2</div>
			</div>
		</li>

		<li>
			<p>Handle the <var>WM_DROPFILES</var> message. In Delphi we can declare a message handler for this event in the main form's class declaration:</p>
			<div id="listing-3" class="frame">
				<div class="code-pascal">
					<pre class="line"><span class="kwd">procedure</span><span class="space"> </span><span class="ident">WMDropFiles</span><span class="sym">(</span><span class="kwd">var</span><span class="space"> </span><span class="ident">Msg</span><span class="sym">:</span><span class="space"> </span><span class="ident">TWMDropFiles</span><span class="sym">)</span><span class="sym">;</span><span class="space"> </span><span class="kwd">message</span><span class="space"> </span><span class="ident">WM_DROPFILES</span><span class="sym">;</span></pre>
				</div>
				<div class="caption">Listing 3</div>
			</div>
		</li>

		<li>
			<p>In the <var>WM_DROPFILES</var> message handler use the <var>DragQueryXXX</var> API functions to retrieve information about the file drop &ndash; see the explanation <a href="#getinfo">below</a>.</p>
		</li>

		<li>
			<p>Notify Windows we have finished with the supplied drop handle. We do this by calling <var>DragFinish</var>, passing it the drop handle we retrieved from the <var>WM_DROPFILES</var> message. This frees the resources used to store information about the drop:</p>
			<div id="listing-4" class="frame">
				<div class="code-pascal">
					<pre class="line"><span class="ident">DragFinish</span><span class="sym">(</span><span class="ident">DropH</span><span class="sym">)</span><span class="sym">;</span></pre>
				</div>
				<div class="caption">Listing 4</div>
			</div>
		</li>

		<li>
			<p>When we are closing down our application we call <var>DragAcceptFiles</var> again, but this time with a final parameter of False to let Windows know we're no longer interested in handling file drops:</p>
			<div id="listing-5" class="frame">
				<div class="code-pascal">
					<pre class="line"><span class="ident">DragAcceptFiles</span><span class="sym">(</span><span class="ident">Form1</span><span class="sym">.</span><span class="ident">Handle</span><span class="sym">,</span><span class="space"> </span><span class="ident">False</span><span class="sym">)</span><span class="sym">;</span></pre>
				</div>
				<div class="caption">Listing 5</div>
			</div>
		</li>
	</ol>

	<h3 id="getinfo">Getting information about dropped files</h3>

	<p>We use two API function to get information about dropped files &ndash; <var>DragQueryFile</var> and <var>DragQueryPoint</var>. Both of these require the drop handle from the <var>WM_DROPFILE</var> messages.</p>

	<h4>DragQueryFile &ndash; jack of all trades</h4>

	<p>Like many Windows API functions, <var>DragQueryFile</var> can perform several functions depending on the parameters passed to it. This makes it hard to remember exactly how to use it. Its parameters (in Delphi-speak) are:</p>

	<ul>
		<li><var>DropHandle: HDROP</var> &ndash; the drop handle provided by the <var>WM_DROPFILES</var> message.</li>
		<li><var>Index: Integer</var> &ndash; the index of the file to query in the list of dropped files.</li>
		<li><var>FileName: PChar</var> &ndash; pointer to a dropped file name.</li>
		<li><var>BufSize: Integer</var> &ndash; size of buffer for the above.</li>
	</ul>

	<p>The three tasks the function performs are:</p>

	<ol class="wide">
		<li>
			<p><em>Finding the number of files dropped.</em></p>
			<p>We get this information by passing $FFFFFFFF as the <var>Index</var>parameter, <span class="keyword">nil</span> as the file name parameter and 0 as the <var>BufSize</var> parameter. The return value is the number of files dropped. Obvious isn't it!</p>
		</li>

		<li>
			<p><em>Finding the size of buffer needed to store the file name at a specific (zero based) index.</em></p>
			<p>We pass the file's index number in the <var>Index</var> parameter, <span class="keyword">nil</span> for the file name and 0 for the buffer size. The function then returns the buffer size required.</p>
		</li>

		<li>
			<p><em>Fetching the name of the file at a given index.</em></p>
			<p>We pass the index number, a <var>PChar</var> buffer large enough to hold the file name (with #0 terminator), and the actual buffer size.</p>
		</li>
	</ol>

	<p>All this makes for extremely unreadable code.<span class="fa fa-thumbs-down fa-x-pad-left" aria-hidden="true"></span> Later in the article we'll hide it all away in a class.</p>

	<h4>DragQueryPoint</h4>

	<p>This function is quite an anti-climax after <var>DragQueryFile</var> &ndash; it simply does what it says and provides the mouse cursor position where the files were dropped. The parameters are:</p>

	<ul>
		<li><var>DropHandle: HDROP</var> &ndash; the drop handle from <var>WM_DROPFILES</var>.</li>
		<li><var><span class="keyword">var</span> Point: TPoint</var> &ndash; reference to a <var>TPoint</var> structure that receives the required point. The function returns non-zero if the drop was in the window's client area and zero if it wasn't.</li>
	</ul>

	<h3 id="solution">Putting it all together</h3>

	<p>Let's pull all we've discovered together in a skeleton Delphi application whose main form, <var>Form1</var>, needs to be able to catch and process dropped files.</p>

	<p>In our form creation event handler we register our interest with Windows:</p>

	<div id="listing-6" class="frame">
		<div class="code-pascal">
			<pre class="line"><span class="linenum">  1</span><span class="kwd">procedure</span><span class="space"> </span><span class="ident">TForm1</span><span class="sym">.</span><span class="ident">FormCreate</span><span class="sym">(</span><span class="ident">Sender</span><span class="sym">:</span><span class="space"> </span><span class="ident">TObject</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  2</span><span class="kwd">begin</span></pre>
			<pre class="line"><span class="linenum">  3</span><span class="space">  </span><span class="comment">// ... other code here</span></pre>
			<pre class="line"><span class="linenum">  4</span><span class="space">  </span><span class="ident">DragAcceptFiles</span><span class="sym">(</span><span class="ident">Self</span><span class="sym">.</span><span class="ident">Handle</span><span class="sym">,</span><span class="space"> </span><span class="ident">True</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  5</span><span class="space">  </span><span class="comment">// ... other code here</span></pre>
			<pre class="line"><span class="linenum">  6</span><span class="kwd">end</span><span class="sym">;</span></pre>
		</div>
		<div class="caption">Listing 6</div>
	</div>

	<p>The meat of the processing comes in the <var>WM_DROPFILES</var> event handler:</p>

	<div id="listing-7" class="frame">
		<div class="code-pascal">
			<pre class="line"><span class="linenum">  1</span><span class="kwd">procedure</span><span class="space"> </span><span class="ident">TForm1</span><span class="sym">.</span><span class="ident">WMDropFiles</span><span class="sym">(</span><span class="kwd">var</span><span class="space"> </span><span class="ident">Msg</span><span class="sym">:</span><span class="space"> </span><span class="ident">TWMDropFiles</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  2</span><span class="kwd">var</span></pre>
			<pre class="line"><span class="linenum">  3</span><span class="space">  </span><span class="ident">DropH</span><span class="sym">:</span><span class="space"> </span><span class="ident">HDROP</span><span class="sym">;</span><span class="space">               </span><span class="comment">// drop handle</span></pre>
			<pre class="line"><span class="linenum">  4</span><span class="space">  </span><span class="ident">DroppedFileCount</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">;</span><span class="space">  </span><span class="comment">// number of files dropped</span></pre>
			<pre class="line"><span class="linenum">  5</span><span class="space">  </span><span class="ident">FileNameLength</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">;</span><span class="space">    </span><span class="comment">// length of a dropped file name</span></pre>
			<pre class="line"><span class="linenum">  6</span><span class="space">  </span><span class="ident">FileName</span><span class="sym">:</span><span class="space"> </span><span class="kwd">string</span><span class="sym">;</span><span class="space">           </span><span class="comment">// a dropped file name</span></pre>
			<pre class="line"><span class="linenum">  7</span><span class="space">  </span><span class="ident">I</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">;</span><span class="space">                 </span><span class="comment">// loops thru all dropped files</span></pre>
			<pre class="line"><span class="linenum">  8</span><span class="space">  </span><span class="ident">DropPoint</span><span class="sym">:</span><span class="space"> </span><span class="ident">TPoint</span><span class="sym">;</span><span class="space">          </span><span class="comment">// point where files dropped</span></pre>
			<pre class="line"><span class="linenum">  9</span><span class="kwd">begin</span></pre>
			<pre class="line"><span class="linenum"> 10</span><span class="space">  </span><span class="kwd">inherited</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 11</span><span class="space">  </span><span class="comment">// Store drop handle from the message</span></pre>
			<pre class="line"><span class="linenum"> 12</span><span class="space">  </span><span class="ident">DropH</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">Msg</span><span class="sym">.</span><span class="ident">Drop</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 13</span><span class="space">  </span><span class="kwd">try</span></pre>
			<pre class="line"><span class="linenum"> 14</span><span class="space">    </span><span class="comment">// Get count of files dropped</span></pre>
			<pre class="line"><span class="linenum"> 15</span><span class="space">    </span><span class="ident">DroppedFileCount</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">DragQueryFile</span><span class="sym">(</span><span class="ident">DropH</span><span class="sym">,</span><span class="space"> </span><span class="hex">$FFFFFFFF</span><span class="sym">,</span><span class="space"> </span><span class="kwd">nil</span><span class="sym">,</span><span class="space"> </span><span class="num">0</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 16</span><span class="space">    </span><span class="comment">// Get name of each file dropped and process it</span></pre>
			<pre class="line"><span class="linenum"> 17</span><span class="space">    </span><span class="kwd">for</span><span class="space"> </span><span class="ident">I</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="num">0</span><span class="space"> </span><span class="kwd">to</span><span class="space"> </span><span class="ident">Pred</span><span class="sym">(</span><span class="ident">DroppedFileCount</span><span class="sym">)</span><span class="space"> </span><span class="kwd">do</span></pre>
			<pre class="line"><span class="linenum"> 18</span><span class="space">    </span><span class="kwd">begin</span></pre>
			<pre class="line"><span class="linenum"> 19</span><span class="space">      </span><span class="comment">// get length of file name</span></pre>
			<pre class="line"><span class="linenum"> 20</span><span class="space">      </span><span class="ident">FileNameLength</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">DragQueryFile</span><span class="sym">(</span><span class="ident">DropH</span><span class="sym">,</span><span class="space"> </span><span class="ident">I</span><span class="sym">,</span><span class="space"> </span><span class="kwd">nil</span><span class="sym">,</span><span class="space"> </span><span class="num">0</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 21</span><span class="space">      </span><span class="comment">// create string large enough to store file</span></pre>
			<pre class="line"><span class="linenum"> 22</span><span class="space">      </span><span class="ident">SetLength</span><span class="sym">(</span><span class="ident">FileName</span><span class="sym">,</span><span class="space"> </span><span class="ident">FileNameLength</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 23</span><span class="space">      </span><span class="comment">// get the file name</span></pre>
			<pre class="line"><span class="linenum"> 24</span><span class="space">      </span><span class="ident">DragQueryFile</span><span class="sym">(</span><span class="ident">DropH</span><span class="sym">,</span><span class="space"> </span><span class="ident">I</span><span class="sym">,</span><span class="space"> </span><span class="ident">PChar</span><span class="sym">(</span><span class="ident">FileName</span><span class="sym">)</span><span class="sym">,</span><span class="space"> </span><span class="ident">FileNameLength</span><span class="space"> </span><span class="sym">+</span><span class="space"> </span><span class="num">1</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 25</span><span class="space">      </span><span class="comment">// process file name (application specific)</span></pre>
			<pre class="line"><span class="linenum"> 26</span><span class="space">      </span><span class="comment">// ... processing code here</span></pre>
			<pre class="line"><span class="linenum"> 27</span><span class="space">    </span><span class="kwd">end</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 28</span><span class="space">    </span><span class="comment">// Optional: Get point at which files were dropped</span></pre>
			<pre class="line"><span class="linenum"> 29</span><span class="space">    </span><span class="ident">DragQueryPoint</span><span class="sym">(</span><span class="ident">DropH</span><span class="sym">,</span><span class="space"> </span><span class="ident">DropPoint</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 30</span><span class="space">    </span><span class="comment">// ... do something with drop point here</span></pre>
			<pre class="line"><span class="linenum"> 31</span><span class="space">  </span><span class="kwd">finally</span></pre>
			<pre class="line"><span class="linenum"> 32</span><span class="space">    </span><span class="comment">// Tidy up - release the drop handle</span></pre>
			<pre class="line"><span class="linenum"> 33</span><span class="space">    </span><span class="comment">// don&apos;t use DropH again after this</span></pre>
			<pre class="line"><span class="linenum"> 34</span><span class="space">    </span><span class="ident">DragFinish</span><span class="sym">(</span><span class="ident">DropH</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 35</span><span class="space">  </span><span class="kwd">end</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 36</span><span class="space">  </span><span class="comment">// Note we handled message</span></pre>
			<pre class="line"><span class="linenum"> 37</span><span class="space">  </span><span class="ident">Msg</span><span class="sym">.</span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="num">0</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 38</span><span class="kwd">end</span><span class="sym">;</span></pre>
		</div>
		<div class="caption">Listing 7</div>
	</div>

	<p>First we record the drop handle in a local variable for convenience and then make the first of those confusing calls to <var>DragQueryFile</var> to get the number of files dropped. Now we loop through each file by index (zero based, remember) and get the file names. For each file name we first get the required buffer size using the second form of <var>DragQueryFile</var>, then create a sufficiently large string by calling <var>SetLength</var>. We finally read the string into the buffer using the third form of <var>DragQueryFile</var>.</p>

	<aside>
		<div class="callout callout-info">

			<h4>Using SetLength</h4>

			<p><var>SetLength(Str, N)</var> creates a buffer large enough for <var>N</var> characters plus the terminating #0. It works correctly with both Unicode and ANSI compilers.</p>

		</div>
	</aside>

	<p>After reading all the file names we then get the drop point. Once all the processing is done we call <var>DragFinish</var> to release the drop handle. Notice we do this in a <span class="keyword">finally</span> section since the drop handle is a resource that we need to ensure is freed, even if there is an exception. We end by settting the message result to 0 to indicate to Windows that we have handled it.</p>

	<p>Finally, we unregister our interest in file drops in the form destruction event handler:</p>

	<div id="listing-8" class="frame">
		<div class="code-pascal">
			<pre class="line"><span class="linenum">  1</span><span class="kwd">procedure</span><span class="space"> </span><span class="ident">TForm1</span><span class="sym">.</span><span class="ident">FormDestroy</span><span class="sym">(</span><span class="ident">Sender</span><span class="sym">:</span><span class="space"> </span><span class="ident">TObject</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  2</span><span class="kwd">begin</span></pre>
			<pre class="line"><span class="linenum">  3</span><span class="space">  </span><span class="comment">// ... other code here</span></pre>
			<pre class="line"><span class="linenum">  4</span><span class="space">  </span><span class="ident">DragAcceptFiles</span><span class="sym">(</span><span class="ident">Self</span><span class="sym">.</span><span class="ident">Handle</span><span class="sym">,</span><span class="space"> </span><span class="ident">False</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  5</span><span class="space">  </span><span class="comment">// ... other code here</span></pre>
			<pre class="line"><span class="linenum">  6</span><span class="kwd">end</span><span class="sym">;</span></pre>
		</div>
		<div class="caption">Listing 8</div>
	</div>

	<h3 id="delphiway">The Delphi Way</h3>

	<p>If you agree with me that all the messing about with API routines rather spoils our Delphi code, what better than to make a helper class to hide a lot of the mess. Here's a small class that can be created and destroyed within the <var>WM_DROPFILES</var> message handler. The class hides away a lot of the code, although we must still handle <var>WM_DROPFILES</var> ourselves. We must also notify Windows of our intention to accept drag drop.</p>

	<p>The class's declaration appears in <span class="figureref">Listing 9</span> while <span class="figureref">Listing 10</span> has the implementation.</p>

	<div id="listing-9" class="frame">
		<div class="code-pascal">
			<pre class="line"><span class="linenum">  1</span><span class="kwd">type</span></pre>
			<pre class="line"><span class="linenum">  2</span><span class="space">  </span><span class="ident">TFileCatcher</span><span class="space"> </span><span class="sym">=</span><span class="space"> </span><span class="kwd">class</span><span class="sym">(</span><span class="ident">TObject</span><span class="sym">)</span></pre>
			<pre class="line"><span class="linenum">  3</span><span class="space">  </span><span class="kwd">private</span></pre>
			<pre class="line"><span class="linenum">  4</span><span class="space">    </span><span class="ident">fDropHandle</span><span class="sym">:</span><span class="space"> </span><span class="ident">HDROP</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  5</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">GetFile</span><span class="sym">(</span><span class="ident">Idx</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="kwd">string</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  6</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">GetFileCount</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  7</span><span class="space">    </span><span class="kwd">function</span><span class="space"> </span><span class="ident">GetPoint</span><span class="sym">:</span><span class="space"> </span><span class="ident">TPoint</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  8</span><span class="space">  </span><span class="kwd">public</span></pre>
			<pre class="line"><span class="linenum">  9</span><span class="space">    </span><span class="kwd">constructor</span><span class="space"> </span><span class="ident">Create</span><span class="sym">(</span><span class="ident">DropHandle</span><span class="sym">:</span><span class="space"> </span><span class="ident">HDROP</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 10</span><span class="space">    </span><span class="kwd">destructor</span><span class="space"> </span><span class="ident">Destroy</span><span class="sym">;</span><span class="space"> </span><span class="kwd">override</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 11</span><span class="space">    </span><span class="kwd">property</span><span class="space"> </span><span class="ident">FileCount</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="space"> </span><span class="kwd">read</span><span class="space"> </span><span class="ident">GetFileCount</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 12</span><span class="space">    </span><span class="kwd">property</span><span class="space"> </span><span class="ident">Files</span><span class="sym">[</span><span class="ident">Idx</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">]</span><span class="sym">:</span><span class="space"> </span><span class="kwd">string</span><span class="space"> </span><span class="kwd">read</span><span class="space"> </span><span class="ident">GetFile</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 13</span><span class="space">    </span><span class="kwd">property</span><span class="space"> </span><span class="ident">DropPoint</span><span class="sym">:</span><span class="space"> </span><span class="ident">TPoint</span><span class="space"> </span><span class="kwd">read</span><span class="space"> </span><span class="ident">GetPoint</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 14</span><span class="space">  </span><span class="kwd">end</span><span class="sym">;</span></pre>
		</div>
		<div class="caption">Listing 9</div>
	</div>

	<div id="listing-10" class="frame">
		<div class="code-pascal">
			<pre class="line"><span class="linenum">  1</span><span class="kwd">constructor</span><span class="space"> </span><span class="ident">TFileCatcher</span><span class="sym">.</span><span class="ident">Create</span><span class="sym">(</span><span class="ident">DropHandle</span><span class="sym">:</span><span class="space"> </span><span class="ident">HDROP</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  2</span><span class="kwd">begin</span></pre>
			<pre class="line"><span class="linenum">  3</span><span class="space">  </span><span class="kwd">inherited</span><span class="space"> </span><span class="ident">Create</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  4</span><span class="space">  </span><span class="ident">fDropHandle</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">DropHandle</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  5</span><span class="kwd">end</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  6</span><span class="space"> </span></pre>
			<pre class="line"><span class="linenum">  7</span><span class="kwd">destructor</span><span class="space"> </span><span class="ident">TFileCatcher</span><span class="sym">.</span><span class="ident">Destroy</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  8</span><span class="kwd">begin</span></pre>
			<pre class="line"><span class="linenum">  9</span><span class="space">  </span><span class="ident">DragFinish</span><span class="sym">(</span><span class="ident">fDropHandle</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 10</span><span class="space">  </span><span class="kwd">inherited</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 11</span><span class="kwd">end</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 12</span><span class="space"> </span></pre>
			<pre class="line"><span class="linenum"> 13</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TFileCatcher</span><span class="sym">.</span><span class="ident">GetFile</span><span class="sym">(</span><span class="ident">Idx</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">)</span><span class="sym">:</span><span class="space"> </span><span class="kwd">string</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 14</span><span class="kwd">var</span></pre>
			<pre class="line"><span class="linenum"> 15</span><span class="space">  </span><span class="ident">FileNameLength</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 16</span><span class="kwd">begin</span></pre>
			<pre class="line"><span class="linenum"> 17</span><span class="space">  </span><span class="ident">FileNameLength</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">DragQueryFile</span><span class="sym">(</span><span class="ident">fDropHandle</span><span class="sym">,</span><span class="space"> </span><span class="ident">Idx</span><span class="sym">,</span><span class="space"> </span><span class="kwd">nil</span><span class="sym">,</span><span class="space"> </span><span class="num">0</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 18</span><span class="space">  </span><span class="ident">SetLength</span><span class="sym">(</span><span class="ident">Result</span><span class="sym">,</span><span class="space"> </span><span class="ident">FileNameLength</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 19</span><span class="space">  </span><span class="ident">DragQueryFile</span><span class="sym">(</span><span class="ident">fDropHandle</span><span class="sym">,</span><span class="space"> </span><span class="ident">Idx</span><span class="sym">,</span><span class="space"> </span><span class="ident">PChar</span><span class="sym">(</span><span class="ident">Result</span><span class="sym">)</span><span class="sym">,</span><span class="space"> </span><span class="ident">FileNameLength</span><span class="space"> </span><span class="sym">+</span><span class="space"> </span><span class="num">1</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 20</span><span class="kwd">end</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 21</span><span class="space"> </span></pre>
			<pre class="line"><span class="linenum"> 22</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TFileCatcher</span><span class="sym">.</span><span class="ident">GetFileCount</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 23</span><span class="kwd">begin</span></pre>
			<pre class="line"><span class="linenum"> 24</span><span class="space">  </span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">DragQueryFile</span><span class="sym">(</span><span class="ident">fDropHandle</span><span class="sym">,</span><span class="space"> </span><span class="hex">$FFFFFFFF</span><span class="sym">,</span><span class="space"> </span><span class="kwd">nil</span><span class="sym">,</span><span class="space"> </span><span class="num">0</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 25</span><span class="kwd">end</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 26</span><span class="space"> </span></pre>
			<pre class="line"><span class="linenum"> 27</span><span class="kwd">function</span><span class="space"> </span><span class="ident">TFileCatcher</span><span class="sym">.</span><span class="ident">GetPoint</span><span class="sym">:</span><span class="space"> </span><span class="ident">TPoint</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 28</span><span class="kwd">begin</span></pre>
			<pre class="line"><span class="linenum"> 29</span><span class="space">  </span><span class="ident">DragQueryPoint</span><span class="sym">(</span><span class="ident">fDropHandle</span><span class="sym">,</span><span class="space"> </span><span class="ident">Result</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 30</span><span class="kwd">end</span><span class="sym">;</span></pre>
		</div>
		<div class="caption">Listing 10</div>
	</div>

	<p>There is not much to explain, given the code we have already seen. The constructor takes a drop handle and records it. The drop handle is &quot;freed&quot; in the destructor with a call to <var>DragFinish</var>. The list of dropped files, the number of files dropped and the drop point are all provided as properties. The accessor methods for the properties are simply wrappers round the <var>DragQueryFile</var> and <var>DragQueryPoint</var> API functions.</p>

	<p>Let us rewrite our original <var>WM_DROPFILES</var> message handler to use the new class:</p>

	<div id="listing-11" class="frame">
		<div class="code-pascal">
			<pre class="line"><span class="linenum">  1</span><span class="kwd">procedure</span><span class="space"> </span><span class="ident">TForm1</span><span class="sym">.</span><span class="ident">WMDropFiles</span><span class="sym">(</span><span class="kwd">var</span><span class="space"> </span><span class="ident">Msg</span><span class="sym">:</span><span class="space"> </span><span class="ident">TWMDropFiles</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  2</span><span class="kwd">var</span></pre>
			<pre class="line"><span class="linenum">  3</span><span class="space">  </span><span class="ident">I</span><span class="sym">:</span><span class="space"> </span><span class="ident">Integer</span><span class="sym">;</span><span class="space">                 </span><span class="comment">// loops thru all dropped files</span></pre>
			<pre class="line"><span class="linenum">  4</span><span class="space">  </span><span class="ident">DropPoint</span><span class="sym">:</span><span class="space"> </span><span class="ident">TPoint</span><span class="sym">;</span><span class="space">          </span><span class="comment">// point where files dropped</span></pre>
			<pre class="line"><span class="linenum">  5</span><span class="space">  </span><span class="ident">Catcher</span><span class="sym">:</span><span class="space"> </span><span class="ident">TFileCatcher</span><span class="sym">;</span><span class="space">      </span><span class="comment">// file catcher class</span></pre>
			<pre class="line"><span class="linenum">  6</span><span class="kwd">begin</span></pre>
			<pre class="line"><span class="linenum">  7</span><span class="space">  </span><span class="kwd">inherited</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  8</span><span class="space">  </span><span class="ident">Catcher</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">TFileCatcher</span><span class="sym">.</span><span class="ident">Create</span><span class="sym">(</span><span class="ident">Msg</span><span class="sym">.</span><span class="ident">Drop</span><span class="sym">)</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum">  9</span><span class="space">  </span><span class="kwd">try</span></pre>
			<pre class="line"><span class="linenum"> 10</span><span class="space">    </span><span class="kwd">for</span><span class="space"> </span><span class="ident">I</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="num">0</span><span class="space"> </span><span class="kwd">to</span><span class="space"> </span><span class="ident">Pred</span><span class="sym">(</span><span class="ident">Catcher</span><span class="sym">.</span><span class="ident">FileCount</span><span class="sym">)</span><span class="space"> </span><span class="kwd">do</span></pre>
			<pre class="line"><span class="linenum"> 11</span><span class="space">    </span><span class="kwd">begin</span></pre>
			<pre class="line"><span class="linenum"> 12</span><span class="space">      </span><span class="comment">// ... code to process file here</span></pre>
			<pre class="line"><span class="linenum"> 13</span><span class="space">    </span><span class="kwd">end</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 14</span><span class="space">    </span><span class="ident">DropPoint</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="ident">Catcher</span><span class="sym">.</span><span class="ident">DropPoint</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 15</span><span class="space">    </span><span class="comment">// ... do something with drop point</span></pre>
			<pre class="line"><span class="linenum"> 16</span><span class="space">  </span><span class="kwd">finally</span></pre>
			<pre class="line"><span class="linenum"> 17</span><span class="space">    </span><span class="ident">Catcher</span><span class="sym">.</span><span class="ident">Free</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 18</span><span class="space">  </span><span class="kwd">end</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 19</span><span class="space">  </span><span class="ident">Msg</span><span class="sym">.</span><span class="ident">Result</span><span class="space"> </span><span class="sym">:=</span><span class="space"> </span><span class="num">0</span><span class="sym">;</span></pre>
			<pre class="line"><span class="linenum"> 20</span><span class="kwd">end</span><span class="sym">;</span></pre>
		</div>
		<div class="caption">Listing 11</div>
	</div>


	<h3 id="gofurther">Going further</h3>

	<p>The <var>TFileCatcher</var> class could be extended to encapsulate all of the drop files functionality, hiding away all the API calls. To do this would require access to the form's window so we could intercept its messages and respond to <var>WM_DROPFILES</var>. One way to do this is to subclass the form's window. It is beyond the scope of this article to look at how that can be done. However, if you want to invetigate further, please check out my <a href="/software/dropfiles">Drop Files components</a>.</p>

</section>

<section id="demo">

	<h2>Demo Application</h2>

	<p>A demo program to accompany this article can be found in the <code><a href="https://github.com/delphidabbler/article-demos">delphidabbler/article-demos</a></code> Git repository on GitHub.</p>

	<p>You can view the code in the <code><a href="https://github.com/delphidabbler/article-demos/tree/master/article-11">article-11</a></code> sub-directory. Alternatively download a zip file containing all the demos by going to the repository's landing page and clicking the <em>Clone or download</em> button and selecting <em>Download ZIP</em>.</p>

	<p>The demo is described in the <a href="https://github.com/delphidabbler/article-demos/blob/master/article-11/README.md">README.md</a> file that is included with the source code.</p>

	<p>The code has been tested with Delphi 4 and Delphi 7.</p>

	<div class="callout callout-info">

		<p><span class="fa fa-code fa-x-pad-right fa-2x fa-pull-left fa-border text-muted"></span>This source code is merely a proof of concept and is intended only to illustrate this article. It is not designed for use in its current form in finished applications. The code is provided on an &quot;AS IS&quot; basis, WITHOUT WARRANTY OF ANY KIND, either express or implied.</p>

		<p>The demo is open source. See the demo's <a href="https://github.com/delphidabbler/article-demos/blob/master/article-11/LICENSE.md">LICENSE.md</a> file for licensing details.</p>

	</div>

</section>

<section id="feedback">

	<h2>Feedback</h2>

	<p>I hope you found this article useful.</p>

	<p>If you have any observations, comments, or have found any errors there are two places you can report them.</p>

	<ol class="wide">

		<li>For anything to do with the article content, <em>but not the downloadable demo code</em>, please use this website's <a href="https://github.com/delphidabbler/delphidabbler.github.io/issues">Issues page</a> on GitHub. Make sure you mention that the issue relates to &quot;article #11&quot;.</li>

		<li>For bugs in the demo code see the <code>article-demo</code> project's <code><a href="https://github.com/delphidabbler/article-demos/blob/master/README.md#bug-reports">README.md</a></code> file for details of how to report them.</li>

	</ol>

</section>
